{% block content %}
{% load static %}
<header class="app-header">
    <nav class="navbar navbar-expand-lg navbar-light">
      <ul class="navbar-nav">
        <li class="nav-item d-block d-xl-none">
          <a class="nav-link sidebartoggler nav-icon-hover" id="headerCollapse" href="javascript:void(0)">
            <i class="bi bi-list"></i>          
          </a>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link nav-icon-hover" href="#" id="notificationDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-bell-fill"></i>              
            <div id="notification-badge" class="notification bg-primary rounded-circle d-none"></div>
          </a>
          <ul class="dropdown-menu p-2" aria-labelledby="notificationDropdown" id="notification-list">
            <div class="d-flex flex-row justify-content-between">
              <li class="dropdown-header">Notifications</li>
              <li class="dropdown-header"><button id="mark-as-read-button" class="btn p-0 m-0"><i class="bi bi-eyeglasses p-0 m-0"></i></button></li>
            </div>            
              
              <li><hr class="dropdown-divider"></li>
              <li class="text-center"><small>You got no notifications</small></li>
          </ul>
      </li>
      <script>
        document.addEventListener("DOMContentLoaded", function () {
        const notificationButton = document.getElementById("notificationDropdown");
        const markAsReadButton = document.getElementById("mark-as-read-button");
        const notificationList = document.getElementById("notification-list");
        const notificationBadge = document.getElementById("notification-badge");

        function fetchNotifications() {
            fetch("/get_notifications/")
                .then(response => response.json())
                .then(data => {
                    notificationList.innerHTML = '<div class="d-flex flex-row justify-content-between"><li class="dropdown-header">Notifications</li><li class="dropdown-header"><button id="mark-as-read-button" class="btn p-0 m-0"><i class="bi bi-eyeglasses p-0 m-0"></i></button></li></div><li><hr class="dropdown-divider"></li>';
                    if (data.notifications && data.notifications.length > 0) {
                        data.notifications.forEach(notification => {
                            const listItem = document.createElement("li");
                            const eventId = notification.event_id;

                            let eventUrl;
                            if( notification.user_type === "staff" ){
                                eventUrl = `/personal_vizualizare_eveniment/${eventId}`;
                            }else if( notification.user_type === "guest" ){
                                eventUrl = `/guest_event_view/${eventId}`;
                            }

                            listItem.innerHTML = `<a class="dropdown-item" href="${eventUrl}">${notification.message} <small class="text-muted">(${notification.timestamp})</small></a>`;
                            notificationList.appendChild(listItem);
                        });
                        notificationBadge.classList.remove("d-none");
                    } else {
                        notificationList.innerHTML += '<li class="text-center"><small>You got no notifications</small></li>';
                        notificationBadge.classList.add("d-none");
                    }
                    document.getElementById("mark-as-read-button").addEventListener("click", markNotificationsAsRead);
                })
                .catch(error => console.error("Error:", error));
        }
        

        function markNotificationsAsRead() {
          fetch("/mark_notifications_as_read/", {
              method: "POST",
              headers: {
                  "Content-Type": "application/json",
                  "X-CSRFToken": getCookie("csrftoken"),
              },
              body: JSON.stringify({}),
          })
          .then(response => response.json())
          .then(data => {
              if (data.status === "success") {
                  notificationBadge.classList.add("d-none");
              }
          })
          .catch(error => console.error("Error:", error));
        }
        markAsReadButton.addEventListener("click", markNotificationsAsRead);
      
        function getCookie(name) {
          let cookieValue = null;
          if (document.cookie && document.cookie !== '') {
              const cookies = document.cookie.split(';');
              for (let i = 0; i < cookies.length; i++) {
                  const cookie = cookies[i].trim();
                  if (cookie.substring(0, name.length + 1) === (name + '=')) {
                      cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                      break;
                  }
              }
          }
          return cookieValue;
      }
      notificationButton.addEventListener("click", fetchNotifications);
        
        setInterval(fetchNotifications, 10000);
        });
      </script>
      </ul>

      <div class="navbar-collapse justify-content-end px-0" id="navbarNav">
        <ul class="navbar-nav flex-row ms-auto align-items-center justify-content-end">
          <li class="nav-item dropdown">
            <a class="nav-link nav-icon-hover" href="javascript:void(0)" id="drop2" data-bs-toggle="dropdown"
              aria-expanded="false">
              <img src="{{ MEDIA_URL }}{{ profile.photo }}" alt="Ceva" width="35" height="35" class="rounded-circle">
            </a>
            <div class="dropdown-menu dropdown-menu-end dropdown-menu-animate-up" aria-labelledby="drop2">
              <div class="message-body">
                {% if profile.user_type == "guest" %}
                <a href="{% url 'guest_home' %}" class="d-flex align-items-center gap-2 dropdown-item">
                {% else %}
                <a href="{% url 'personal_profile' %}" class="d-flex align-items-center gap-2 dropdown-item">
                {% endif %}
                  <i class="ti ti-user fs-6"></i>
                  <p class="mb-0 fs-3">My Profile</p>
                </a>
                <a href="{% url 'logout' %}" class="btn btn-outline-primary mx-3 mt-2 d-block">Logout</a>
              </div>
            </div>
          </li>
        </ul>
      </div>

    </nav>
  </header>
{% endblock %}