{% extends 'main.html' %}
{% block navbar %}
{% endblock %}
{% load static %}
{% block content %}

<style>
    .glass-effect {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 15px;
        backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .table-controls {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
    }
    .table-form select,
    .table-form input {
        padding: 8px;
        border-radius: 5px;
        border: 1px solid #dee2e6;
    }
    .table-form button {
        padding: 8px 15px;
        border-radius: 5px;
        border: none;
        background: #007bff;
        color: white;
        cursor: pointer;
    }
    .table-form button:hover {
        background: #0056b3;
    }
    #konva-container {
        width: 100% !important;
        min-width: 300px;
        max-width: 100%;
        height: 600px;
        border: 1px solid #ccc;
        background: #f8f9fa;
        border-radius: 15px;
        margin-top: 20px;
        display: block;
    }
    #edit-panel {
        position: absolute;
        min-width: 120px;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 12px;
        box-shadow: 0 2px 16px #0001;
        padding: 14px 12px 10px 12px;
        z-index: 2000;
        display: none;
    }
    #edit-panel h5 {
        font-size: 1.1rem;
        margin-bottom: 8px;
    }
    #edit-panel .btn {
        margin-top: 8px;
    }
    .konva-rotate-handle {
        pointer-events: all;
        cursor: pointer;
    }
</style>

<div class="page-wrapper" id="main-wrapper" data-layout="vertical" data-navbarbg="skin6" data-sidebartype="full"
data-sidebar-position="fixed" data-header-position="fixed">
      <!-- Sidebar Start -->
      {% include 'sidebar.html' %}
      <!--  Main wrapper -->
      <div class="body-wrapper">
        <!--  Header Start -->
        {% include 'header.html' %}        
        
        <div class="container-fluid">
          <div class="row">
            <div class="col-lg-12">
                    <div class="card glass-effect">
                        <div class="card-body">
                            <h1 class="card-title text-center mb-4">
                                Layout Management
                          </h1>
                            <p class="text-center mb-4">
                                Here you can customize your location's layout. {{ location.name }} Add, remove, and arrange tables to match your venue's setup.
                            </p>
                            <p class="text-center mb-4">
                                <strong>Total tables:</strong> {{ tables.count }}, <strong> and special elements:</strong> {{ special_elements.count }}
                            </p>

                            <div class="mb-3">
                                <h5 class="card-title mb-4">
                                    Special Elements
                                </h5>
                                <div class="special-elements-controls d-flex flex-wrap gap-1">
                                    <button type="button" class="btn btn-outline-success" data-element="entrance">üö™ Entrance</button>
                                    <button type="button" class="btn btn-outline-primary" data-element="dancefloor">üíÉ Dance Floor</button>
                                    <button type="button" class="btn btn-outline-warning" data-element="dj">üéß DJ/Band</button>
                                    <button type="button" class="btn btn-outline-info" data-element="restrooms">üöª Restrooms</button>
                                    <button type="button" class="btn btn-outline-secondary" data-element="bar">üç∏ Bar</button>
                                    <button type="button" class="btn btn-outline-dark" data-element="kitchen">üçΩÔ∏è Kitchen</button>
                                    <button type="button" class="btn btn-outline-danger" data-element="emergency">üö® Emergency Exit</button>
                                    <button type="button" class="btn btn-outline-danger" data-element="photobooth">üì∏ Photo Booth</button>
                                    <button type="button" class="btn btn-outline-warning" data-element="kids">üß∏ Kids Area</button>
                                    <button type="button" class="btn btn-success" id="btnAddCustom">+ Add Custom</button>
                                </div>
                            </div>

                            <!-- Canvas Container -->
                            <div id="konva-container"></div>

                            <!-- Save Button -->
                            
                            <div class="text-center mt-3 d-flex justify-content-between">
                                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTableModal">
                                    + Add a new table
                                </button>
                                
                                <button id="save-positions" class="btn btn-success">
                                    <i class="fas fa-save"></i> Save Layout
                                </button>
                            </div>
                        </div>
                      </div>
                  </div>
            </div>
          </div>
    </div>
</div>

  <div class="modal fade" id="addTableModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title" id="addTableModalLabel">Add a new table</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <form id="addTableForm" class="table-form">
                {% csrf_token %}
            <div class="mb-3">
              <label for="shape" class="form-label">Table shape</label>
              <select name="shape" class="form-select" required>
                <option value="round">Round</option>
                <option value="rect">Rectangle</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="capacity" class="form-label">Capacity</label>
              <input type="number" name="capacity" class="form-control" placeholder="Capacity" min="1" required>
            </div>
            <div class="mb-3">
              <label for="table_number" class="form-label">Table number</label>
              <input type="number" name="table_number" class="form-control" placeholder="Table number" min="1" required>
            </div>
            <div class="form-check mb-3">
              <input type="checkbox" name="is_vip" class="form-check-input" id="isVip">
              <label class="form-check-label" for="isVip">Reserved</label>
            </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Add Table</button>
          <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancel</button>
        </div>
    </form>
           
      </div>
    </div>
</div>
  
<!-- Table Details Modal -->
<div class="modal fade" id="tableDetailsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Table Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editTableForm">
                    {% csrf_token %}
                    <input type="hidden" name="table_id" id="editTableId">
                    <div class="mb-3">
                        <label class="form-label">Table Number</label>
                        <input type="number" name="table_number" id="editTableNumber" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Capacity</label>
                        <input type="number" name="capacity" id="editCapacity" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Shape</label>
                        <select name="shape" id="editShape" class="form-select" required>
                            <option value="round">Round</option>
                            <option value="rect">Rectangle</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" id="deleteTable">Delete Table</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveTableChanges">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<div id="edit-panel">
    <h5 id="edit-panel-title"></h5>
    <button id="edit-panel-delete" class="btn btn-danger btn-sm w-100">Delete</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/konva@9.2.2/konva.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>


document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('konva-container');
    let width = container.offsetWidth;
    let height = container.offsetHeight || 600;
    const stage = new Konva.Stage({
        container: 'konva-container',
        width: width,
        height: height
    });
    const layer = new Konva.Layer();

    const gridLayer = new Konva.Layer({ listening: false });
    const gridSize = 50;
    function drawGrid() {
        const cols = Math.ceil(width / gridSize);
        const rows = Math.ceil(height / gridSize);
        for (let i = 0; i <= cols; i++) {
            gridLayer.add(new Konva.Line({
                points: [i * gridSize, 0, i * gridSize, height],
                stroke: '#e0e0e0',
                strokeWidth: 1
            }));
        }
        for (let j = 0; j <= rows; j++) {
            gridLayer.add(new Konva.Line({
                points: [0, j * gridSize, width, j * gridSize],
                stroke: '#e0e0e0',
                strokeWidth: 1
            }));
        }
    }
    drawGrid();
    stage.add(gridLayer);
    stage.add(layer);

    const transformer = new Konva.Transformer({
        rotateEnabled: true,
        enabledAnchors: ['top-left', 'top-center', 'top-right', 'middle-left', 'middle-right', 'bottom-left', 'bottom-center', 'bottom-right'],
        anchorStroke: '#007bff',
        anchorFill: '#ffffff',
        anchorSize: 10,
        anchorCornerRadius: 5,
        borderStroke: '#007bff',
        borderDash: [3, 3],
    });
    layer.add(transformer);

    window.addEventListener('resize', function() {
        const newWidth = container.offsetWidth;
        stage.width(newWidth);
        layer.draw();
        gridLayer.destroyChildren();
        drawGrid();
        gridLayer.draw();
    });

    const tables = [
        {% for table in tables %}
        {
            id: {{ table.id }},
            table_number: "T.{{ table.table_number }}",
            capacity: {{ table.capacity }},
            shape: "{{ table.shape }}",
            is_vip: {% if table.is_vip %}true{% else %}false{% endif %},
            x: Math.round({{ table.position_x|default:50 }} / 100 * width),
            y: Math.round({{ table.position_y|default:50 }} / 100 * height),
            rotation: {{ table.rotation|default:0 }},
            width: {{ table.width|default:0 }},
            height: {{ table.height|default:0 }},
            radius: {{ table.radius|default:0 }}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    // Draw tables
    tables.forEach(function(table) {
        createTable(table);
    });

    function createTable(tableData) {
        const group = new Konva.Group({
            x: tableData.x,
            y: tableData.y,
            draggable: true,
            id: 'table-' + tableData.id,
            rotation: tableData.rotation || 0
        });

        const isRound = tableData.shape === 'round';
        const radius = isRound ? (tableData.radius && tableData.radius > 0 ? tableData.radius : 45) : null;
        const rectW = !isRound ? (tableData.width && tableData.width > 0 ? tableData.width : 150) : null;
        const rectH = !isRound ? (tableData.height && tableData.height > 0 ? tableData.height : 90) : null;

        const shape = isRound
            ? new Konva.Circle({
                radius: radius,
                fill: tableData.is_vip ? '#ffd700' : '#82faea',
                stroke: tableData.is_vip ? '#b8860b' : '#439c99',
                strokeWidth: 2,
                shadowBlur: tableData.is_vip ? 15 : 3
            })
            : new Konva.Rect({
                width: rectW,
                height: rectH,
                fill: tableData.is_vip ? '#ffd700' : '#82faea',
                stroke: tableData.is_vip ? '#b8860b' : '#439c99',
                strokeWidth: 2,
                cornerRadius: 12,
                shadowBlur: tableData.is_vip ? 15 : 3
            });

        const text = new Konva.Text({
            text: tableData.table_number,
            fontSize: 28,
            fontStyle: 'bold',
            fill: tableData.is_vip ? '#8b4513' : 'black',
            width: isRound ? radius*2 : rectW,
            height: 32,
            align: 'center',
            verticalAlign: 'middle',
            x: isRound ? -radius : 0,
            y: isRound ? -18 : rectH/2 - 16
        });

        const cap = new Konva.Text({
            text: tableData.capacity + ' ppl.',
            fontSize: 15,
            fill: tableData.is_vip ? '#8b4513' : 'black',
            width: isRound ? radius*2 : rectW,
            height: 20,
            align: 'center',
            verticalAlign: 'middle',
            x: isRound ? -radius : 0,
            y: isRound ? 10 : rectH/2 + 8
        });

        group._tableData = tableData;
        group._tableRotation = tableData.rotation || 0;
        group.add(shape);
        group.add(text);
        group.add(cap);

        layer.add(group);
        layer.draw();
    }

    // Add new table
    document.getElementById('addTableForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        
        fetch('{% url "add_table" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                createTable(data.table);
                this.reset();
                const modalElement = document.getElementById('addTableModal');
                const modalInstance = bootstrap.Modal.getInstance(modalElement);
                modalInstance.hide();
            } else {
                alert('Error adding table: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error adding table');
        });
    });

    // Save table changes
    document.getElementById('saveTableChanges').addEventListener('click', function() {
        const formData = new FormData(document.getElementById('editTableForm'));
        
        fetch('{% url "update_table" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const tableGroup = layer.findOne('#table-' + data.table.id);
                if (tableGroup) {
                    layer.destroyChildren();
                    tables.forEach(function(table) {
                        if (table.id === data.table.id) {
                            Object.assign(table, data.table);
                        }
                        createTable(table);
                    });
                }
                bootstrap.Modal.getInstance(document.getElementById('tableDetailsModal')).hide();
            } else {
                alert('Error updating table: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating table');
        });
    });

    // Delete table
    document.getElementById('deleteTable').addEventListener('click', function() {
        if (confirm('Are you sure you want to delete this table?')) {
            const tableId = document.getElementById('editTableId').value;
            
            fetch('{% url "delete_table" %}', {
                method: 'POST',
                body: JSON.stringify({ table_id: tableId }),
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const tableGroup = layer.findOne('#table-' + tableId);
                    if (tableGroup) {
                        tableGroup.destroy();
                        layer.draw();
                    }
                    bootstrap.Modal.getInstance(document.getElementById('tableDetailsModal')).hide();
                } else {
                    alert('Error deleting table: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deleting table');
            });
        }
    });

    // --- Special Elements Definitions ---
    const specialElements = {
        entrance: {
            shape: 'rect', color: 'green', width: 60, height: 20, icon: '', label: 'Entrance'
        },
        dancefloor: {
            shape: 'rect', color: '#b39ddb', width: 200, height: 120, icon: '', opacity: 0.3, label: 'Dance Floor'
        },
        dj: {
            shape: 'circle', color: '#ffb300', radius: 25, icon: '', label: 'DJ/Band'
        },
        restrooms: {
            shape: 'rect', color: '#90caf9', width: 50, height: 50, icon: '', label: 'Restrooms'
        },
        bar: {
            shape: 'rect', color: '#ffe082', width: 150, height: 30, icon: '', label: 'Bar'
        },
        kitchen: {
            shape: 'rect', color: '#616161', width: 80, height: 60, icon: '', label: 'Kitchen'
        },
        emergency: {
            shape: 'rect', color: 'red', width: 60, height: 20, icon: '', label: 'Emergency Exit'
        },
        photobooth: {
            shape: 'circle', color: '#f06292', radius: 30, icon: '', label: 'Photo Booth'
        },
        kids: {
            shape: 'rect', color: '#fff59d', width: 70, height: 50, icon: '', label: 'Kids Area'
        },
        custom: {
            shape: 'rect', color: '#c5e1a5', width: 80, height: 40, icon: '', label: 'Custom'
        }
    };

    function addSpecialElementToCanvas(type, x, y, rotation, w, h, r, customLabel=null) {
        const def = specialElements[type];
        const labelText = customLabel || def.label;
        let group = new Konva.Group({
            x: x || 100 + Math.random() * 200,
            y: y || 100 + Math.random() * 200,
            draggable: true,
            rotation: rotation || 0
        });
        let shape;
        if (def.shape === 'rect') {
            const rectWidth = w && w>0 ? w : def.width;
            const rectHeight = h && h>0 ? h : def.height;
            shape = new Konva.Rect({
                width: rectWidth,
                height: rectHeight,
                fill: def.color,
                cornerRadius: 10,
                shadowBlur: 3
            });
            if(def.opacity){ shape.opacity(def.opacity); }
        } else if (def.shape === 'circle') {
            const cRadius = r && r>0 ? r : def.radius;
            shape = new Konva.Circle({
                radius: cRadius,
                fill: def.color,
                shadowBlur: 3
            });
            if(def.opacity){ shape.opacity(def.opacity); }
        }
        const label = new Konva.Text({
            text: labelText,
            fontSize: 14,
            fill: '#222',
            x: def.shape === 'rect' ? 0 : - (def.shape==='circle' ? (r && r>0 ? r : def.radius) : 0),
            y: def.shape === 'rect' ? ((h && h>0 ? h : def.height)+2) : ((r && r>0 ? r : def.radius)+2),
            width: def.shape === 'rect' ? (w && w>0 ? w : def.width) : ((r && r>0 ? r : def.radius)*2),
            align: 'center'
        });
        group._specialType = type;
        group._specialLabel = labelText;
        group._specialRotation = rotation || 0;
        group.add(shape);
        group.add(label);
        layer.add(group);
        layer.draw();
        // End of element creation
    }

    // --- Save layout (include rotation) ---
    document.getElementById('save-positions').addEventListener('click', function() {
        const positions = [];
        const specialElements = [];
        layer.getChildren().forEach(function(group) {
            if (group._tableData) {
                positions.push({
                    id: group._tableData.id,
                    x: group.x() / width * 100,
                    y: group.y() / height * 100,
                    rotation: group.rotation(),
                    width: group.findOne('Rect') ? group.findOne('Rect').width() * group.scaleX() : undefined,
                    height: group.findOne('Rect') ? group.findOne('Rect').height() * group.scaleY() : undefined,
                    radius: group.findOne('Circle') ? group.findOne('Circle').radius() * group.scaleX() : undefined
                });
            }
            if (group._specialType) {
                specialElements.push({
                    type: group._specialType,
                    label: group._specialLabel,
                    x: group.x() / width * 100,
                    y: group.y() / height * 100,
                    rotation: group.rotation(),
                    width: group.findOne('Rect') ? group.findOne('Rect').width() * group.scaleX() : undefined,
                    height: group.findOne('Rect') ? group.findOne('Rect').height() * group.scaleY() : undefined,
                    radius: group.findOne('Circle') ? group.findOne('Circle').radius() * group.scaleX() : undefined
                });
            }
        });
        fetch('{% url "save_table_layout" %}', {
            method: 'POST',
            body: JSON.stringify({ tables: positions, special_elements: specialElements }),
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Layout saved successfully!');
            } else {
                alert('Error saving layout: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error saving layout');
        });
    });

    // --- Load special elements from backend context (include rotation) ---
    const specialElementsFromBackend = [
        {% for el in special_elements %}
        {
            type: "{{ el.type }}",
            label: "{{ el.label }}",
            x: {{ el.position_x }},
            y: {{ el.position_y }},
            rotation: {{ el.rotation|default:0 }},
            width: {{ el.width|default:0 }},
            height: {{ el.height|default:0 }},
            radius: {{ el.radius|default:0 }}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    specialElementsFromBackend.forEach(function(el) {
        addSpecialElementToCanvas(el.type, el.x * width / 100, el.y * height / 100, el.rotation, el.width, el.height, el.radius, el.label);
    });

    // --- Load special elements on page load ---
    // (loadSpecialElements call removed)

    let selectedGroup = null;
    let rotateHandle = null;
    const editPanel = document.getElementById('edit-panel');
    const editPanelTitle = document.getElementById('edit-panel-title');
    const editPanelDelete = document.getElementById('edit-panel-delete');

    function selectGroup(group) {
        deselectGroup();
        selectedGroup = group;
        // Attach Konva.Transformer for this group
        transformer.nodes([group]);
        transformer.getLayer().batchDraw();
        const bbox = group.getClientRect({ relativeTo: group.getLayer() });
        // Update panel langa forma
        const canvasRect = stage.container().getBoundingClientRect();
        editPanel.style.display = 'block';
        editPanelTitle.textContent = group._tableData ? 'Table #' + group._tableData.table_number : group._specialLabel;
        editPanel.style.left = (canvasRect.left + bbox.x + bbox.width + 30) + 'px';
        editPanel.style.top = (canvasRect.top + bbox.y) + 'px';
        // Bind delete
        editPanelDelete.onclick = function() {
            Swal.fire({
                title: 'Are you sure?',
                text: 'This element will be deleted!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    group.destroy();
                    deselectGroup();
                    layer.draw();
                    Swal.fire('Deleted!', 'The element has been deleted.', 'success');
                }
            });
        };
    }
    function deselectGroup() {
        selectedGroup = null;
        transformer.nodes([]);
        transformer.getLayer().batchDraw();
        editPanel.style.display = 'none';
    }
    layer.on('click tap', function(e) {
        if (e.target && e.target.getParent() && e.target.getParent() !== layer) {
            const group = e.target.getParent();
            selectGroup(group);
        }
    });
    stage.on('click tap', function(e) {
        if (e.target === stage) {
            deselectGroup();
        }
    });

    document.querySelectorAll('.special-elements-controls button[data-element]').forEach(btn => {
        btn.addEventListener('click', function() {
            const type = this.getAttribute('data-element');
            addSpecialElementToCanvas(type);
        });
    });

    document.getElementById('btnAddCustom').addEventListener('click', function(){
        Swal.fire({
            title: 'Add custom element',
            input: 'text',
            inputLabel: 'Label / Name',
            inputPlaceholder: 'e.g. Gift Table',
            showCancelButton: true,
            inputValidator: (value)=>{ if(!value){return 'Label required';}}
        }).then((result)=>{
            if(result.isConfirmed){
                addSpecialElementToCanvas('custom', null, null, null, null, null, null, result.value.trim());
            }
        });
    });
});
</script>
{% endblock %}