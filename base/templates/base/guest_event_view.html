{% extends 'main.html' %}
{% block navbar %}
{% endblock %}


{% block content %}
{% load static %}

<div class="page-wrapper" id="main-wrapper" data-layout="vertical" data-navbarbg="skin6" data-sidebartype="full"
data-sidebar-position="fixed" data-header-position="fixed">

  <!-- Sidebar Start -->
    {% include 'sidebar.html' %}

  <!--  Main wrapper -->
  <div class="body-wrapper">

    <!--  Header Start -->
    {% include 'header.html' %}

    <div class="container-fluid">
      <div class="row" id="event-status" data-event-id="{{ event.id }}" data-current-status="{{ event.status }}">
        <div class="col-lg-12">

          <div class="card box">
              <div class="card-body d-flex flex-column">
                  {% if event.status == "upcoming" %}
                    <div class="card-title h1 text-center">Checkout the details about the event!</div> 
                  {% elif event.status == "ongoing" %}  
                    <div class="card-title h1 text-center">The event is live!</div> 
                  {% else %}
                    <div class="card-title h1 text-center">Review the details about the event!</div> 
                  {% endif %}
                    <div class="title text-center"><p class="h2 fs-5">{{ event.event_name }}</p></div>             
              </div>
          </div>
                <div class="row">

                  <div class="col-lg-3">
                        <div class="card">
                          <div class="card-body" style="padding: 20px;">
                        <div class="image d-flex flex-column justify-content-center">
                            <img src="{{MEDIA_URL}}{{ event.location.gallery }}" alt="" srcset="" class="img-fluid border border-radius-2" style="max-height: 300px;">
                            <h3 class="text-center">{{ event.location.name }}</h3>
                          </div>
                        <hr>
                        <div class="col-lg-12 d-flex flex-column justify-content-center">
  
                          <h1 class="text-center"><i class="bi bi-clock"></i></h1>
                          {% include 'timer.html' %}
                        </div>
                        <hr>
                        <div class="col-lg-12 p-1">
                          <h4 class="text-center">Location on map</h4>
                          <div class="mapouter" style="flex: 1;">
                            <div class="gmap_canvas">
                                <iframe class="gmap_iframe" frameborder="0" scrolling="no" marginheight="0" marginwidth="0"
                                  src="https://maps.google.com/maps?width=600&amp;height=400&amp;hl=en&amp;q={{ event.location.name|urlencode }}&amp;t=&amp;z=14&amp;ie=UTF8&amp;iwloc=B&amp;output=embed"></iframe>
                            </div>
                            <style>
                                .mapouter {
                                    position: relative;
                                    text-align: right;
                                    width: 100%;
                                }
                    
                                .gmap_canvas {
                                    overflow: hidden;
                                    background: none !important;
                                    width: 100%; 
                                    height: 100%; 
                                }
                    
                                .gmap_iframe {
                                    width: 100% !important; 
                                    height: 100% !important; 
                                }
                            </style>
                        </div>
                      </div>
                      </div>
                    </div>
                  </div>

                  <div class="col-lg-9" style="border-left:2px solid #dee2e6;">
                    <div class="card">
                      <div class="card-body">
                        <div class="row">
                        <h2 class="text-center">You are invited to {{ event.event_name }} at {{ event.location.name }}!</h2>
                        {% if rsvp.response == "Pending" %}
                          <p class="text-center">You have not confirmed your attendance yet. Please confirm your attendance to explore the menu available for you!</p>
                        {% elif rsvp.response == "Accepted" %}
                          <p class="text-center">You have confirmed your attendance, now you can explore the menu options and generate a personalised menu for you!</p>
                        {% elif rsvp.response == "Declined" %}
                          <p class="text-center">You have declined to attend {{ event.event_name }} at {{ event.location.name }}!</p>
                      {% endif %}
                      <div class="d-flex justify-content-center">
                      <ul class="nav nav-pills mt-3 mb-3" id="eventTabs">
                        <li class="nav-item"><a data-bs-toggle="pill" href="#general" class="nav-link active">General</a></li>
                        <li class="nav-item"><a data-bs-toggle="pill" href="#galley" class="nav-link">Gallery</a></li>
                        <li class="nav-item"><a data-bs-toggle="pill" href="#completed" class="nav-link">Completed</a></li>
                      </ul>
                      </div>
                      <div class="tab-content">
                        <div id="general" class="tab-pane fade show active" data-event-status="{{ event.status }}">
                          <div id="menuGrid" class="row g-4">
                            <div class="col-lg-12 d-flex flex-column" style="min-height: 200px;">
                              <h3 class="ms-2">Preferences:</h3>
                              <div class="row d-flex flex-row">
                                <table class="table table-bordered align-items-center text-center ms-2">
                                  <thead>
                                    <tr>
                                      <th><i class="bi bi-cup-hot text-center"></i> Cuisine</th>
                                      <th><i class="bi bi-egg"></i> Diet</th>
                                      <th><i class="bi bi-fire"></i> Spicy</th>
                                      <th><i class="bi bi-egg-fried"></i> Texture</th>
                                      <th><i class="bi bi-nut"></i> Nutrition</th>
                                      <th><i class="bi bi-heart-pulse"></i> Medical</th>
                                      <th><i class="bi bi-virus"></i> Allergens</th>
                                    </tr>
                                  </thead>
                                  <tbody>
                                    <tr>
                                      <td>{{ preferences.cuisine_preference }}</td>
                                      <td>{{ preferences.diet_preference }}</td>
                                      <td>{{ preferences.spicy_food }}</td>
                                      <td>{{ preferences.texture_preference }}</td>
                                      <td>{{ preferences.nutrition_goal }}</td>
                                      {% if preferences.medical_conditions.all %}
                                      <td>{{ preferences.medical_conditions.all|join:", " }}</td>
                                      {% else %}
                                      <td>No medical conditions</td>
                                      {% endif %}
                                      {% if preferences.allergens.all %}
                                      <td>{{ preferences.allergens.all|join:", " }}</td>
                                      {% else %}
                                      <td>No allergens</td>
                                      {% endif %}
                                    </tr>
                                  </tbody>
                                </table>
                                
                              </div>
      
                              <div class="flex justify-content-center">
                                <a href="{% url 'guest_profile' %}" class="btn btn-primary">Change preferences</a>
                              </div> 
                            </div>
                            <hr>
                            <div class="col-lg-12">
                                <h3 class="">Attendence status:</h3>
                                <div class="d-flex justify-content-start align-items-center">
                                  <p class="h2">Your current status: </p>
                                  {% if rsvp.response == "Pending" %}
                                    <p class="btn btn-warning p-2 ms-2" disabled>Pending</p>
                                  {% elif rsvp.response == "Accepted" %}
                                    <p class="btn btn-success p-2 ms-2" disabled>Accepted</p>
                                  {% elif rsvp.response == "Declined" %}
                                    <p class="btn btn-danger p-2 ms-2" disabled>Declined</p>
                                  {% endif %}
                                  <div class="p-2 ms-auto">
                                    <form action="" method="POST">
                                      {% csrf_token %}
                                      {% if rsvp.response == "Accepted" %}
                                      <button type="submit" name="response" value="Declined" class="btn btn-danger" onclick="confirmPresence(event, 'cancel')">Cancel presence!</button>
                                      {% elif rsvp.response == "Pending" or rsvp.response == "Declined" %}
                                      <button type="submit" name="response" value="Accepted" class="btn btn-warning" onclick="confirmPresence(event, 'confirm')">Confirm presence!</button>
                                      {% endif %}
                                    </form>
                                  </div>
                              </div>
                            </div>
                            <hr>
                            <script>
                              function confirmPresence(event, action) {
                                  event.preventDefault();
            
                                  let message = (action === 'confirm') 
                                      ? "Are you sure that you want to atend to the event?"
                                      : "Are you sure that you want to cancel the attendance?";
                                  
                                      Swal.fire({
                                          title: "Confirmation",
                                          text: message,
                                          icon: "warning",
                                          showCancelButton: true,
                                          confirmButtonText: "Yes",
                                          cancelButtonText: "No",
                                      }).then((result) => {
                                          if (result.isConfirmed) {
                                              let form = event.target.closest("form");
                                              let input = document.createElement("input");
                                              input.type = "hidden";
                                              input.name = "response";
                                              input.value = (action === 'confirm') ? "Accepted" : "Declined";
                                              form.appendChild(input);
                                              form.submit();
                                          }
                                      });
                              }
                            </script>
                            <div class="col-lg-12">
    
                              <div class="d-flex flex-column justify-content-center">
                                <h1 class="h1 text-center">Configure the menu for this event</h1>
                                {% if rsvp.response == "Pending" %}
                                  <p class="p-2 ms-2 text-center" disabled>Aceept the invitation so you can configure the menu</p>
                                {% elif rsvp.response == "Accepted" %}
                                  <p class="p-2 ms-2 text-center" disabled>Down below you can configure the menu for this event</p>
                                {% elif rsvp.response == "Declined" %}
                                  <p class="p-2 ms-2 text-center" disabled>Declined the invitation so you can't configure the menu</p>
                                {% endif %}
                              </div>
            
                              <hr>
                              <div class="d-flex justify-content-center mt-1 mb-2" id="menuGrid">
                                <!-- <button class="btn btn-primary me-2" id="explore-menu-btn">Explore the menu by yourself</button> -->
                                 {% if rsvp.response == "Accepted" %}
                                  {% if event.status == "completed" or event.status == "ongoing" %}
                                    <p class="p-2 ms-2 text-center" disabled>The event is completed so you can't generate a menu</p>
                                  {% else %}
                                  <button class="btn btn-primary" id="generate-menu">Generate personalised menu for you</button>
                                  {% endif %}
                                {% endif %}
                              </div>
    
                              <!-- <form action="" method="POST" id="menu-configuration" hidden>
                                  {% csrf_token %}
                              <div class="row d-flex flex-row mt-4">
    
                                <div class="menus col-lg-6">
                                  <h4 class="h4">Choose appetizer:</h4>
                                  <select name="appetizer" class="form-select" id="foodSelect">
                                    <option value="">-- see the menu --</option>
                                    {% for food in appetizers %}
                                      <option value="{{food.id}}">{{food.item_name}}</option>
                                    {% endfor %}
                                  </select>
                                </div>
            
                                <div id="foodDetails" class="col-lg-6 flex-column" style="display: none;">
                                    <h4 id="foodName"></h4>
                                    <p><strong>Allergens:</strong> <span id="foodAllergens"></span></p>
                                    <p><strong>Vegan:</strong> <span id="foodType"></span></p>
                                    <img id="foodImage" src="" alt="Food Image" style="max-width: 300px;  max-height: 300px; object-fit: cover; display: none;">
                                </div>
            
            
                                <div id="step1" class="col-lg-6 flex-column mt-2" style="display: none;">
                                  <hr>
                                  <h4 class="h4">Pick main course</h4>
                                  <select id="mainCourse" class="form-select">
                                      <option value="">-- see the menu --</option>
                                      {% for food in main_courses %}
                                          <option value="{{ food.id }}">{{ food.item_name }}</option>
                                      {% endfor %}
                                  </select>
                                </div>
            
                                <div id="mainCourseDetails" class="col-lg-6 flex-column" style="display: none;">
                                  <h4 id="mainCourseFoodName"></h4>
                                  <p><strong>Allergens:</strong> <span id="mainCourseFoodAllergens"></span></p>
                                  <p><strong>Vegan:</strong> <span id="mainCourseFoodType"></span></p>
                                  <img id="mainCourseFoodImage" src="" alt="Food Image" style="max-width: 300px;  max-height: 300px; object-fit: cover;  display: none;">
                                </div>
            
            
                                <div id="step2" class="col-lg-6 flex-column mt-2" style="display: none;">
                                  <hr>
                                  <h4 class="h4">Select desert</h4>
                                  <select id="desertSelect" class="form-select">
                                      <option value="">-- Select the desert --</option>
                                      {% for food in desserts %}
                                          <option value="{{ food.id }}">{{ food.item_name }}</option>
                                      {% endfor %}
                                  </select>
                                </div>
            
                                <div id="step2Details" class="col-lg-6 flex-column" style="display: none;">
                                  <h4 id="step2FoodName"></h4>
                                  <p><strong>Allergens:</strong> <span id="step2FoodAllergens"></span></p>
                                  <p><strong>Vegan:</strong> <span id="step2FoodType"></span></p>
                                  <img id="step2FoodImage" src="" alt="Food Image" style="max-width: 300px; max-height: 300px; object-fit: cover; display: none;">
                                </div>
            
            
                                <div id="step3" class="col-lg-6 flex-column mt-2" style="display: none;">
                                  <hr>
                                    <h4 class="h4">Choose drinks</h4>
                                    <select id="step3Select" class="form-select">
                                        <option value="">-- Select the drink --</option>
                                        {% for food in drinks %}
                                            <option value="{{ food.id }}">{{ food.item_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
              
                                <div id="step3Details" class="col-lg-6 flex-column" style="display: none;">
                                  <h4 id="step3FoodName"></h4>
                                  <p><strong>Allergens:</strong> <span id="step3FoodAllergens"></span></p>
                                  <p><strong>Vegan:</strong> <span id="step3FoodType"></span></p>
                                  <img id="step3FoodImage" src="" alt="Food Image" style="max-width: 300px; max-height: 300px; object-fit: cover; display: none;">
                                </div>
              
                                <div id="finalStep" class="col-lg-12 flex-column" style="display: none;">
                                    <h3>You picked:</h3>
                                    <ul id="selections-list">
                                        <li>Appetizer: <span id="chosenAperitiv"></span></li>
                                        <li>Main course: <span id="chosenFelPrincipal"></span></li>
                                        <li>Desert: <span id="chosenDesert"></span></li>
                                        <li>Drinks: <span id="chosenDrinks"></span></li>
                                    </ul>
                                    <button type="submit" id="confirmSelection" class="btn btn-success">Confirm</button>
                                </div>
                              </div>
                              </form> -->
                              
                              <div id="suggested-menu" class="row g-3">
                              </div>
                              <div id="menu-data" data-event-id="{{ event.id }}" data-location-id="{{ location.id }}"></div>
    
                              <div id="submit-menu-container" class="mt-4">
                                <p class="text-center">Once you selected all the dishes, you can submit the menu.</p>
                              
                            </div>
                            <script>
                          document.getElementById("generate-menu").addEventListener("click", () => {
                            fetch("/generate-menu/")
                            .then(res => res.json())
                            .then(data => {
                                const container = document.getElementById("suggested-menu");
                                container.innerHTML = "";
    
                              const MEDIA_URL = "{{ MEDIA_URL }}";
                              const ALL_DISHES = JSON.parse('{{ all_dishes_json|escapejs }}');
                              const GUEST_ALLERGENS = JSON.parse('{{ guest_allergens_json|escapejs }}');
    
                              for (const [category, dishes] of Object.entries(data.menu)) {
                                  const headerRow = document.createElement("div");
                                  headerRow.className = "d-flex align-items-center justify-content-between mt-4 w-100";

                                  const title = document.createElement("h4");
                                  title.className = "text-primary fw-bold text-capitalize m-0";
                                  title.textContent = category;

                                  const subTitle = document.createElement("h5");
                                  subTitle.className = "text-secondary m-0 ms-3";
                                  subTitle.textContent = `You have ${dishes.length} suggestions for this category. Please choose one.`;

                                  headerRow.appendChild(title);
                                  headerRow.appendChild(subTitle);
                                  container.appendChild(headerRow);

                                  const row = document.createElement("div");
                                  row.className = "row g-3 mb-4 dish-row";
                                  row.setAttribute("data-category", category.toLowerCase());
    
                                  if (dishes.length) {
                                      dishes.forEach(item => {
                                          const col = document.createElement("div");
                                          col.className = "col-lg-4 fade-in-top";
    
                                          let allergenHTML = '';
                                          if (item.allergens.length) {
                                              allergenHTML = item.allergens.map(name => `<span class="allergen-badge">${name}</span>`).join(', ');
                                          } else {
                                              allergenHTML = `<span class="no-allergens">No allergens</span>`;
                                          }
                                          const veganHTML = item.is_vegan
                                              ? `<i class="ti ti-message-2 text-dark fs-5"></i> vegan`
                                              : `<i class="ti ti-message-2 text-dark fs-5"></i> non-vegan`;
    
                              col.innerHTML = `
                                  <div class="card overflow-hidden hover-img card-hover shadow-sm h-100">
                                      <div class="position-relative">
                                          <img src="${item.image || MEDIA_URL + 'placeholder.jpg'}" class="card-img-top" style="max-height: 150px; object-fit: cover;" alt="dish image">
                                      </div>
                                      <div class="card-body p-3">
                                          <a class="d-block fs-5 m-0 text-dark fw-semibold link-primary" href="#">${item.name}</a>
                                          <div class="d-flex align-items-center gap-2 mt-3">
                                              <div class="d-flex align-items-center flex-wrap gap-1">
                                                  <p class="m-0 text-primary">Allergens:</p>
                                                  ${allergenHTML}
                                              </div>
                                              <div class="d-flex align-items-center flex-wrap gap-1">
                                                  <p>Diet:</p>
                                                  ${item.diet_type}
                                              </div>
                                              <div class="d-flex align-items-center flex-wrap gap-1">
                                                  <p>Region:</p>
                                                  <i class="ti ti-point text-dark me-1"></i>${item.region}
                                              </div>
                                          </div>
                                      </div>
                                      <div class="text-center mb-2 mt-2">
                                          <input type="radio" id="dish-${item.id}" name="${category.toLowerCase()}" class="dish-option form-check-input" data-id="${item.id}" value="${item.id}">
                                          <label class="form-check-label" for="dish-${item.id}">Select</label>
                                      </div>
                                  </div>
                                  `;
                              row.appendChild(col);
                          });                      
                      } else {
                          const msg = document.createElement("div");
                          msg.className = "alert alert-danger fade-in-top mt-2";
                          msg.textContent = `Nicio sugestie pentru categoria: ${category.toLowerCase()}.`;
                          const button = document.createElement("button");
                          button.className = "btn-close";
                          button.setAttribute("data-bs-dismiss", "alert");
                          button.setAttribute("type", "button");
                          button.setAttribute("aria-label", "Close");
                          msg.appendChild(button);  
                          row.appendChild(msg);
                      }
    
                      container.appendChild(row);
                    }
    
                    data.messages.forEach(msg => {
                        const alert = document.createElement("div");
                        alert.className = "alert alert-warning fade-in-top mt-2";
                        alert.textContent = msg;
                        container.appendChild(alert);
                    });
                  })
                  .catch(err => {
                      console.error("Eroare la generarea meniului:", err);
                      const container = document.getElementById("suggested-menu");
                      const errorMsg = document.createElement("div");
                      errorMsg.className = "alert alert-danger mt-3";
                      errorMsg.textContent = "A apărut o eroare la generarea meniului. Încearcă din nou.";
                      container.appendChild(errorMsg);
                        });
                    });
    
                    
                        </script>
    
    <style>
    .fade-in-top {
      animation: fadeInDown 0.5s ease-in-out;
    }
    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    </style>
    
                            <script>
                              const exploreBtn=document.getElementById('explore-menu-btn');
                              if(exploreBtn){
                                exploreBtn.addEventListener('click', function () {
                                    const formElem = document.getElementById('menu-configuration');
                                    if(formElem){
                                      formElem.removeAttribute('hidden');
                                      formElem.scrollIntoView({ behavior: 'smooth' });
                                    }
                                });
                              }
                            </script>
    
                            <script>
                              document.addEventListener('DOMContentLoaded', function() {
                                const form = document.getElementById('menu-configuration');
                                if(!form) return;
                                const selects = form.querySelectorAll('select');
                                const selectionsList = document.getElementById('selections-list');
    
                                // Restaurare stare salvată
                                function restoreSelections() {
                                  const savedSelections = JSON.parse(localStorage.getItem('eventMenuSelections')) || {};
                                  selects.forEach(select => {
                                    if (savedSelections[select.name]) {
                                      select.value = savedSelections[select.name];
                                    }
                                  });
                                  updateSelectionsDisplay();
                                }
    
                                // Actualizare afișaj selecții
                                function updateSelectionsDisplay() {
                                  selectionsList.innerHTML = '';
                                  selects.forEach(select => {
                                    if (select.value) {
                                      const li = document.createElement('li');
                                      li.textContent = `${select.name}: ${select.value}`;
                                      selectionsList.appendChild(li);
                                    }
                                  });
                                }
    
                                // Salvare automată la schimbare
                                selects.forEach(select => {
                                  select.addEventListener('change', function() {
                                    const currentSelections = JSON.parse(localStorage.getItem('eventMenuSelections')) || {};
                                    currentSelections[this.name] = this.value;
                                    localStorage.setItem('eventMenuSelections', JSON.stringify(currentSelections));
                                    updateSelectionsDisplay();
                                  });
                                });
    
                                // Trimitere formular
                                form.addEventListener('submit', function(e) {
                                  e.preventDefault();
                                  
                                  const formData = new FormData(this);
                                  const selections = Object.fromEntries(formData.entries());
                                  
                                  fetch('/save-menu-configuration', {
                                    method: 'POST',
                                    headers: {
                                      'Content-Type': 'application/json',
                                      'X-CSRFToken': getCookie('csrftoken'), 
                                    },
                                    body: JSON.stringify(selections)
                                  })
                                  .then(response => response.json())
                                  .then(data => {
                                    if (data.success) {
                                      localStorage.removeItem('eventMenuSelections');
                                      alert('Meniu salvat cu succes!');
                                    }
                                  });
                                });
    
                                // Inițializare
                                restoreSelections();
                              });
    
                            </script>
    
                              <script>
                                function setupFoodSelection(selectId, detailsContainerId, nameId, allergensId, typeId, imageId, stepId) {
                                  const selectElem = document.getElementById(selectId);
                                  if(!selectElem) return; // element missing

                                  selectElem.addEventListener("change", function() {
                                    let foodId = this.value;
                                    let detailsContainer = document.getElementById(detailsContainerId);
                                    let nameElement = document.getElementById(nameId);
                                    let allergensElement = document.getElementById(allergensId);
                                    let typeElement = document.getElementById(typeId);
                                    let imageElement = document.getElementById(imageId);
                                    let stepElement = document.getElementById(stepId);
                
                                    if (foodId) {
                                        fetch(`/get_food_details/${foodId}/`)
                                            .then(response => response.json())
                                            .then(data => {
                                                nameElement.innerText = data.name;
                                                allergensElement.innerText = data.allergens.join(", ");
                                                typeElement.innerText = data.type;
                
                                                if (data.image) {
                                                    imageElement.src = data.image;
                                                    imageElement.style.display = "flex";
                                                } else {
                                                    imageElement.style.display = "none";
                                                }
                
                                                stepElement.style.display = "flex";
                                                detailsContainer.style.display = "flex";
                                            })
                                            .catch(error => console.error("Eroare:", error));
                                    } else {
                                        detailsContainer.style.display = "none";
                                    }
                                });
                            }
                
                            setupFoodSelection("foodSelect", "foodDetails", "foodName", "foodAllergens", "foodType", "foodImage", "step1");
                            setupFoodSelection("mainCourse", "mainCourseDetails", "mainCourseFoodName", "mainCourseFoodAllergens", "mainCourseFoodType", "mainCourseFoodImage", "step2");
                            setupFoodSelection("desertSelect", "step2Details", "step2FoodName", "step2FoodAllergens", "step2FoodType", "step2FoodImage", "step3");
                            setupFoodSelection("step3Select", "step3Details", "step3FoodName", "step3FoodAllergens", "step3FoodType", "step3FoodImage", "finalStep");
                
                              </script>
            
                            
                            </div>
                          </div>
                        </div>
                        <div id="galley" class="tab-pane fade">
                          <div class="row">
                            <div class="col-lg-12">
                              <h3 class="text-center mb-3">Gallery</h3>
                              <div class="gallery-masonry">
                                {% for photo in gallery %}
                                  <div class="gallery-masonry-item">
                                    <img src="{{ MEDIA_URL }}{{ photo.image }}" alt="Gallery image" loading="lazy" onclick="openGalleryLightbox(this)">
                                  </div>
                                {% empty %}
                                  <p class="text-center">No images available.</p>
                                {% endfor %}
                              </div>
                            </div>
                          </div>
                          <style>
                            .gallery-masonry {
                              column-width: 250px;
                              column-gap: 1rem;
                              width: 100%;
                            }

                            .gallery-masonry-item {
                              break-inside: avoid;
                              margin-bottom: 1rem;
                              position: relative;
                            }

                            .gallery-masonry-item img {
                              width: 100%;
                              height: auto;
                              border-radius: 6px;
                              object-fit: cover;
                              cursor: pointer;
                              transition: transform 0.2s ease-in-out;
                            }

                            .gallery-masonry-item img:hover {
                              transform: scale(1.03);
                            }
                          </style>

                          <div class="lightbox" id="galleryLightbox" onclick="closeGalleryLightbox()" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); justify-content:center; align-items:center; z-index:9999;">
                            <span class="close-btn-gallery" onclick="closeGalleryLightbox()" style="position:absolute; top:20px; right:30px; font-size:30px; color:white; cursor:pointer;">&times;</span>
                            <img id="galleryLightboxImg" style="max-width:90%; max-height:90%; border-radius:5px;"/>
                          </div>

                          <script>
                            function openGalleryLightbox(img) {
                              const lb = document.getElementById('galleryLightbox');
                              document.getElementById('galleryLightboxImg').src = img.src;
                              lb.style.display = 'flex';
                            }

                            function closeGalleryLightbox() {
                              document.getElementById('galleryLightbox').style.display = 'none';
                            }
                          </script>
                        </div>
                        <div id="completed" class="tab-pane fade">
                          <div class="row justify-content-center">
                              {% if event.status == "completed" %}
                              <h3 class="text-center">Completed</h3>
                                <link rel="stylesheet" href="{% static 'css/posts.css' %}">
                                <style>
                                  .star-rating {
                                      display: flex;
                                      flex-direction: row-reverse;
                                      justify-content: flex-end;
                                      font-size: 2rem;
                                      line-height: 2rem;
                                  }
                                  
                                  .star-rating input {
                                      display: none;
                                  }
                                  
                                  .star-rating label {
                                      color: #ccc;
                                      cursor: pointer;
                                      transition: color 0.2s;
                                  }
                                  
                                  .star-rating input:checked ~ label,
                                  .star-rating label:hover,
                                  .star-rating label:hover ~ label {
                                      color: #ffc107;
                                  }
                                  .filled{
                                    color: #ffc107;
                                  }
                                </style>
                                  
                                    {% load custom_filters %}
                      
                                    <h1 class="h1">The event ended!</h1> 
                                    <p>You can create a new post and interact with other users!</p>
                                    <hr>
                                    <h3 class="archives-title">
                                      Checkout the archives with photos from this event!
                                    </h3>
                                    <div class="card">
                                      <div class="card-body d-flex flex-column">
                                        {% for archive in archives %}
                                          <div class="archive-item">
                                            Downlaod archive - <a href="{{ archive.archive.url }}" download>{{ archive.archive.name|basename }} <i class="bi bi-file-earmark-arrow-down"></i></a>
                                            <p>Uploaded - {{ archive.uploaded_at }}</p>
                                          </div>
                                          {% empty %}
                                            <li>The archives with photos for this event will be available to download soon.</li>
                                        {% endfor %}
                                      </div>
                                    </div>
                                    <h3 class="archives-title">
                                      Rate the food and the organization!
                                    </h3>
                                    <div class="d-flex flex-row justify-content-center gap-4 align-items-center">
                                      <div class="organizer-rate d-flex flex-column justify-content-center align-items-center mb-3">
                                        <img src="{{ MEDIA_URL }}{{ event.organized_by.profile_set.all.0.photo }}" alt="Ceva" width="70" height="70" style="object-fit: cover;" class="rounded-circle">
                                        <div class="organizer-info d-flex flex-column align-items-center justify-content-center">
                                          <span class="organizer-name text-center">{{ event.organized_by.profile_set.all.0.username }}</span>
                                          <span class="organizer-rating" id="organizer-rating">
                                            <div class="star-rating" data-kind="organizer" data-organizer-id="{{ event.organized_by.id }}">
                                              {% if review_organizer %}
                                                {% for i in "54321" %}
                                                  <span class="stele{% if review_organizer.organizer_stars >= i|add:'0' %} filled{% endif %}">★</span>
                                                {% endfor %}
                                              {% else %}
                                                {% for i in "54321" %}
                                                  <input type="radio" id="organized-{{ event.organized_by.id }}-{{ i }}" name="rating-{{ event.organized_by.id }}" value="{{ i }}">
                                                  <label for="organized-{{ event.organized_by.id }}-{{ i }}" title="{{ i }} stars">★</label>
                                                {% endfor %}
                                              {% endif %}
                                            </div>
                                          </span>
                                        </div>
                                      </div>
                                      <div class="location-rate d-flex flex-column justify-content-center align-items-center mb-3">
                                        <img src="{{ MEDIA_URL }}{{ event.location.gallery }}" alt="Ceva" width="70" height="70" style="object-fit: cover;" class="rounded-circle">
                                        <div class="location-info d-flex flex-column align-items-center justify-content-center">
                                          <span class="location-name text-center">{{ event.location.name }}</span>
                                          <span class="location-rating" id="location-rating">
                                            <div class="star-rating" data-kind="location" data-location-id="{{ event.location.id }}">
                                              {% if review_location %}
                                                {% for i in "54321" %}
                                                  <span class="stele{% if review_location.location_stars >= i|add:'0' %} filled{% endif %}">★</span>
                                                {% endfor %}
                                              {% else %}
                                                {% for i in "54321" %}
                                                  <input type="radio" id="location-{{ event.location.id }}-{{ i }}" name="rating-{{ event.location.id }}" value="{{ i }}">
                                                  <label for="location-{{ event.location.id }}-{{ i }}" title="{{ i }} stars">★</label>
                                                {% endfor %}
                                              {% endif %}
                                            </div>
                                          </span>
                                        </div>
                                      </div>
                                    </div>
                                    <div class="row ">
                                      {% for dish in chosen_menu %}
                                        <div class="col-md-6">
                                          <div class="dish-item d-flex align-items-center mb-3">
                                            <img src="{{ dish.image }}" alt="" width="100" height="100" style="object-fit: cover;" class="rounded-circle">
                                            <div class="d-flex flex-column">
                                              <div class="food-info ms-2">
                                                <p class="mb-0">{{ dish.category|capfirst }}: {{ dish.name }}</p>
                                                <p class="mb-0">Allergens: {{ dish.allergens|join:', ' }}</p>
                                                <p class="mb-0">Diet type: {{ dish.diet_type }}</p>
                                                <p class="mb-0">Region: {{ dish.item_cuisine }}</p>
                                              </div>
                                              {% if dish.rating %}
                                                <input type="hidden" name="rating-{{ dish.id }}" id="rated-dish" value="{{ dish.rating }}">
                                                <div class="star-rating">
                                                  {% for i in "54321" %}
                                                      <span class="stele{% if dish.rating >= i|add:'0' %} filled{% endif %}">★</span>
                                                  {% endfor %}
                                                </div>
                                              {% else %}
                                                <form method="post" action="">
                                                  {% csrf_token %}
                                                    <div class="star-rating" data-dish-id="{{ dish.id }}">
                                                      {% for i in "54321" %}
                                                        <input type="radio" id="star-{{ dish.id }}-{{ i }}" name="rating-{{ dish.id }}" value="{{ i }}">
                                                        <label for="star-{{ dish.id }}-{{ i }}" title="{{ i }} stars">★</label>
                                                      {% endfor %}
                                                    </div>
                                                </form>
                                                {% endif %} 
                                              </div>
                                            </div>
                                        </div>
                                      {% empty %}
                                          <li>You didn't configure a custom menu for this event.</li>
                                      {% endfor %}    
                                    </div>
                                    
                                    <div class="d-flex justify-content-center">
                                      {% if rated_item_count < 4 %}
                                        <button class="btn btn-primary" id="send-ratings">Send ratings</button>
                                      {% endif %}
                                    </div>
                          </div>
                          <hr>
                          <script>
                          document.getElementById('send-ratings').addEventListener('click', () => {
                            const ratings = [];
                            document.querySelectorAll('.star-rating').forEach(div => {
                              const checked = div.querySelector('input[type="radio"]:checked');
                              if (!(checked && !checked.disabled)) return;
    
                              const kind = div.dataset.kind || 'dish';
                              if (kind === 'dish') {
                                ratings.push({ kind: 'dish', dish_id: div.dataset.dishId, rating: parseInt(checked.value) });
                              } else if (kind === 'organizer') {
                                ratings.push({ kind: 'organizer', organizer_id: div.dataset.organizerId, rating: parseInt(checked.value) });
                              } else if (kind === 'location') {
                                ratings.push({ kind: 'location', location_id: div.dataset.locationId, rating: parseInt(checked.value) });
                              }
                            });
                            fetch("{% url 'save_menu_ratings' %}", {
                              method: "POST",
                              headers: { "Content-Type": "application/json",
                                          "X-CSRFToken": "{{ csrf_token }}",
                                          "X-Requested-With": "XMLHttpRequest" },
                              body: JSON.stringify(ratings)
                            })
                            .then(r => r.json())
                            .then(data => {
                                if (data.success) {
                                  alert("Saved rating.");
                                }
                            });
                          });
                          </script>
                            {% if guest_posts_count > 0 %}
                            <a class="btn btn-primary dropdown-toggle dropdown-toggle-split" data-bs-toggle="collapse" href="#postCollapse" role="button" aria-expanded="false" aria-controls="postCollapse">
                              Add more posts!
                            </a>
                            <div class="collapse" id="postCollapse">
                              <div class="card mt-4">
                                <div class="card-body">
                                  <h3 class="h3">Create a post for - {{ event.event_name }}</h3>
                                  <form method="post" id="post-form" enctype="multipart/form-data">
                                      {% csrf_token %}
                                      {{ form.non_field_errors }}
                                      
                                      <div class="mb-3">
                                        <label class="form-label">Rating:</label>
                                        <div class="star-rating">
                                          {% for i in "54321" %}
                                          <input type="radio" id="star-{{ i }}" name="rating" value="{{ i }}"
                                                {% if form.rating.value == i %}checked{% endif %}>
                                          <label for="star-{{ i }}" title="{{ i }} stele">★</label>
                                          {% endfor %}
                                          {{ form.rating }}
                                        </div>
                                        {% if form.rating.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.rating.errors.as_text }}
                                        </div>
                                        {% endif %}
              
                                      </div>
              
                                      <div class="mb-3">
                                        {{ form.title.label_tag }}
                                        {{ form.title }}
                                        {% if form.title.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.title.errors.as_text }}
                                        </div>
                                        {% endif %}
                                      </div>
                                      
                                      <div class="mb-3">
                                        {{ form.content.label_tag }}
                                        {{ form.content }}
                                        {% if form.content.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.content.errors.as_text }}
                                        </div>
                                        {% endif %}
                                      </div>
              
                                      <div class="mb-3">
                                        <label for="id_images">Images (maximum 10)</label>
                                        <input type="file" name="images" id="id_images" 
                                              class="form-control" multiple
                                              accept="image/jpeg, image/png, image/gif">
                                        {{ form.images.errors }}
                                        <div id="image-preview" class="mt-2"></div>
                                      </div>
                                      
                                      <button type="submit" name="form_type" value="add_post" class="btn btn-primary">Create Post</button>
                                      <a href="{% url 'guest_event_view' event.id %}" class="btn btn-danger">Cancel</a>
                                  </form>
                                </div> 
                              </div>
                            </div>
                            {% else %}
                                <h3 class="h3">Create a post for - {{ event.event_name }}</h3>
                                <div class="card mt-4">
                                  <div class="card-body">
                                    <form method="post" id="post-form" enctype="multipart/form-data">
                                        {% csrf_token %}
                                        {{ form.non_field_errors }}
                                        
                                        <div class="mb-3">
                                          <label class="form-label">Rating:</label>
                                          <div class="star-rating">
                                            {% for i in "54321" %}
                                            <input type="radio" id="star-{{ i }}" name="rating" value="{{ i }}"
                                                  {% if form.rating.value == i %}checked{% endif %}>
                                            <label for="star-{{ i }}" title="{{ i }} stele">★</label>
                                            {% endfor %}
                                            {{ form.rating }}
                                          </div>
                                          {% if form.rating.errors %}
                                          <div class="invalid-feedback d-block">
                                              {{ form.rating.errors.as_text }}
                                          </div>
                                          {% endif %}
              
                                        </div>
              
                                        <div class="mb-3">
                                          {{ form.title.label_tag }}
                                          {{ form.title }}
                                          {% if form.title.errors %}
                                          <div class="invalid-feedback d-block">
                                              {{ form.title.errors.as_text }}
                                          </div>
                                          {% endif %}
                                    </div>
                                      
                                        <div class="mb-3">
                                          {{ form.content.label_tag }}
                                          {{ form.content }}
                                          {% if form.content.errors %}
                                          <div class="invalid-feedback d-block">
                                              {{ form.content.errors.as_text }}
                                          </div>
                                          {% endif %}
                                    </div>
              
                                    <div class="mb-3">
                                      <label for="id_images">Images (maximum 10)</label>
                                      <input type="file" name="images" id="id_images" 
                                            class="form-control" multiple
                                            accept="image/jpeg, image/png, image/gif">
                                      {{ form.images.errors }}
                                      <div id="image-preview" class="mt-2"></div>
                                    </div>
                                      
                                        <button type="submit" name="form_type" value="add_post" class="btn btn-primary">Create Post</button>
                                        <a href="{% url 'guest_event_view' event.id %}" class="btn btn-danger">Cancel</a>
                                    </form>
                                  </div> 
                                </div>
                            {% endif %}
                              <script>
                                document.querySelector('form').addEventListener('submit', function(e) {
                                  const files = document.getElementById('id_images').files;
                                  if (files.length > 10) {
                                      e.preventDefault();
                                      alert('You can upload maximum 10 images.');
                                  }
                              });
              
                                document.addEventListener('DOMContentLoaded', function() {
                                    const stars = document.querySelectorAll('.star-rating input');
                                    const hiddenInput = document.getElementById('id_rating');
                                    
                                    stars.forEach(star => {
                                        star.addEventListener('change', function() {
                                            hiddenInput.value = this.value;
                                        });
                                    });
                                
                                });
              
              
                              </script>
                            <hr>
                            {% if event.posts.count == 0 %}
                              <h3 class="h3">Be the first one to add a post for this event!</h3>
                            {% else %}
                              <h3 class="h3">See {{event_posts.count}} posts down below</h3>
                            {% endif %}  
                            
                            <hr>
                            {% for post in event_posts %}
                            <div class="card">
                              <div class="card-body">
                                <div class="timeline-body mt-4">
                                  <div class="timeline-header">
                                    <span class="userimage"><img src="{{MEDIA_URL}}{{post.author.profile_set.all.0.photo}}" alt=""></span>
                                    <span class="username"><a href="javascript:;">{{post.author.profile_set.all.0.username}}</a> <small></small></span>
                                    {% if  post.author == request.user %}
                                    <span class="pull-right text-danger"><a role="button" onclick="confirmDeleteDish({{ post.id }})">Delete post <i class="bi bi-trash"></i></a></span>
                                    {% endif %}
                                  </div>
                                  <div class="timeline-content">
                                    <h3 class="h3">{{post.title}}</h3>
                                    <p>
                                      <div class="star-rating">
              
                                        {% for i in "54321" %}
                                            <span class="stele{% if post.rating >= i|add:'0' %} filled{% endif %}">★</span>
                                        {% endfor %}
                                    </div>                 
                                      {{post.content}}
                                    </p>
              
                                    {% if post.images.all %}
                                      {% for photo in post.images.all %}
                                        <img class="img-fluid rounded m-1" src="{{MEDIA_URL}}{{photo.image}}" alt="Post Image" onclick="openLightbox(this)" style="max-width: 150px; max-height: 100px; object-fit: cover;" onerror="this.style.display='none';">
                                      {% endfor %}
                                    {% endif %}
                                  </div>
                                  <style>
                                    .gallery img:hover {
                                          transform: scale(1.1);
                                      }
              
                                      .lightbox {
                                          display: none;
                                          position: fixed;
                                          top: 0;
                                          left: 0;
                                          width: 100%;
                                          height: 100%;
                                          background: rgba(0, 0, 0, 0.8);
                                          justify-content: center;
                                          align-items: center;
                                          z-index: 9999;
                                      }
              
                                      .lightbox img {
                                          max-width: 90%;
                                          max-height: 90%;
                                          border-radius: 5px;
                                      }
              
                                      .close-btn-gallery {
                                          position: absolute;
                                          top: 20px;
                                          right: 30px;
                                          font-size: 30px;
                                          color: white;
                                          cursor: pointer;
                                      }
                                      .image-container {
                                          position: relative;
                                          display: inline-block;
                                          margin: 10px;
                                      }
                                  </style>
                                  <div class="lightbox" id="lightbox" onclick="closeLightbox()">
                                    <span class="close-btn-gallery" onclick="closeLightbox()">&times;</span>
                                    <img id="lightbox-img">
                                  </div>
                                  <script>
                                    function openLightbox(img) {
                                          document.getElementById("lightbox").style.display = "flex";
                                          document.getElementById("lightbox-img").src = img.src;
                                      }
                              
                                      function closeLightbox() {
                                          document.getElementById("lightbox").style.display = "none";
                                      }
              
                                      function confirmDeleteDish(postId) {
                                        Swal.fire({
                                            title: 'Post delete confirmation',
                                            text: "Are you sure that you want to delete this post?",
                                            icon: 'warning',
                                            showCancelButton: true,
                                            confirmButtonColor: '#d33',
                                            cancelButtonColor: '#3085d6',
                                            confirmButtonText: 'Yes, delete it!',
                                            cancelButtonText: 'Cancel'
                                        }).then((result) => {
                                            if (result.isConfirmed) {
                                                fetch(`/delete_post/${postId}/`, {
                                                    method: 'DELETE',
                                                    headers: {
                                                        'X-CSRFToken': getCSRFToken(),
                                                        'Content-Type': 'application/json'
                                                    }
                                                })
                                                .then(response => {
                                                    if (!response.ok) throw new Error('Network error');
                                                    return response.json();
                                                })
                                                .then(data => {
                                                    if (data.success) {
                                                        Swal.fire('Deleted!', data.message || 'The post has been removed.', 'success')
                                                        .then(() => location.reload());
                                                    } else {
                                                        throw new Error(data.error || 'Unknown error');
                                                    }
                                                })
                                                .catch(error => {
                                                    Swal.fire('Eroare!', error.message, 'error');
                                                });
                                            }
                                        });
                                    }
              
                                    function getCSRFToken() {
                                        return document.querySelector('[name=csrfmiddlewaretoken]').value;
                                    }
                                  </script>
                                  <div class="timeline-likes">
                                    <div class="stats-right">
                                      <span class="fa-stack fa-fw stats-icon">
                                        </span>
                                        <span class="stats-text" id="like-count-{{post.id}}">{{post.like_count}} likes</span>
                                      <span class="fa-stack fa-fw stats-icon">
                                        </span>
                                        <span class="stats-text">{{post.comments.count}} comments</span>
                                    </div>
                                    <div class="stats">
                      
                                    </div>
                                  </div>
                                  <div class="timeline-footer">
                                    {% if request.user == post.likes.user %}
                                    <p>Liked</p>
                                    {% endif %}
                                    <a class="m-r-15 text-inverse-lighter like-btn" role="button" data-post-id="{{ post.id }}" id="like-btn-{{ post.id }}"><i class="bi {% if post.is_liked %}bi-heart-fill text-danger{%else%}bi-heart{%endif%}"></i> Like</a>
                                    <a class="m-r-15 text-inverse-lighter ms-1" data-bs-toggle="collapse" href="#collapsePost{{post.id}}" role="button" aria-expanded="false" aria-controls="collapsePost{{post.id}}"><i class="bi bi-chat-dots-fill"></i> Comment</a> 
                                  </div>
                                  <div class="collapse" id="collapsePost{{post.id}}">
                                    {% if post.comments.all %}
                                      {% for comment in post.comments.all %}
                                      <div class="timeline-comment-box" data-comment-id="{{ comment.id }}" id="comment-{{ comment.id }}" style="background-color: white;">
                                        <div class="user"><img src="{{ MEDIA_URL }}{{ comment.author.profile_set.all.0.photo }}"></div>
                                          <div class="comment_elements d-flex flex-row justify-content-center align-items-center">
                                            <p class="flex-grow-1 ms-4">{{ comment.text }}</p>
                                            <p class="me-2">{{ comment.created_at }}</p>
                                            {% if comment.author == request.user %}
                                              <button class="btn btn-danger btn-sm delete-comment-btn mt-1" data-comment-id="{{ comment.id }}">Delete</button>
                                            {% endif %}
                                          </div>  
                                      </div>
                                      {% endfor %}
                                    {% endif %}
                                    <div class="timeline-comment-box">
                                      <div class="user"><img src="{{MEDIA_URL}}{{profile.photo}}"></div>
                                      <div class="input">
                                          <form method="POST" action="{% url 'add_comment' post.id %}" class="comment-form">
                                            {% csrf_token %}
                                            <div class="input-group">
                                                <input type="text" name="text" class="form-control rounded-corner me-2" placeholder="Write a comment...">
                                                <span class="input-group-btn p-l-10 d-flex align-items-center justify-content-center">
                                                  <button class="f-s-12 rounded-corner border border-0" type="submit"><i class="bi bi-send-plus-fill"></i></button>
                                                </span>
                                            </div>
                                          </form>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                            {% endfor %}
                            <script>
                              document.querySelectorAll('.delete-comment-btn').forEach(button => {
                                button.addEventListener('click', function() {
                                  const commentId = this.dataset.commentId;
              
                                  Swal.fire({
                                    title: 'Are you sure?',
                                    text: "The comment will be detelet permanently!",
                                    icon: 'warning',
                                    showCancelButton: true,
                                    confirmButtonColor: '#d33',
                                    cancelButtonColor: '#3085d6',
                                    confirmButtonText: 'Detele',
                                    cancelButtonText: 'Dont'
                                  }).then((result) => {
                                    if (result.isConfirmed) {
                                      fetch(`/delete_comment/${commentId}/`, {
                                        method: 'POST',
                                        headers: {
                                          'X-CSRFToken': getCSRFToken(),
                                        }
                                      })
                                      .then(response => response.json())
                                      .then(data => {
                                        if (data.success) {
                                          const commentDiv = document.querySelector(`[data-comment-id="${commentId}"]`);
                                          commentDiv.remove();
              
                                          Swal.fire(
                                            'Deleted!',
                                            'The comment was removed.',
                                            'success'
                                          )
                                        } else {
                                          Swal.fire('Error', data.error || 'There was an error.', 'error');
                                        }
                                      });
                                    }
                                  });
                                });
                              });
              
                              function getCSRFToken() {
                                const cookieValue = document.cookie
                                  .split('; ')
                                  .find(row => row.startsWith('csrftoken='))
                                  ?.split('=')[1];
                                return cookieValue;
                              }
                            </script>
              
              
              
                            <script>
                              document.addEventListener('DOMContentLoaded', function() {
                                document.body.addEventListener('click', function(event) {
                                    const likeBtn = event.target.closest('.like-btn');
                                    if (!likeBtn) return;
              
                                    const postId = likeBtn.dataset.postId;
                                    
                                    likeBtn.disabled = true;
                                    
                                    fetch(`/like/${postId}`, {
                                        method: 'POST',
                                        headers: {
                                            'X-CSRFToken': '{{ csrf_token }}',
                                            'Content-Type': 'application/json',
                                        },
                                        credentials: 'same-origin'
                                    }).then(response => {
                                        if(!response.ok) {
                                            throw new Error('Network response was not ok');
                                        }
                                        return response.json();
                                    })
                                    .then(data => {
                                        const likeBtn = document.querySelector(`#like-btn-${postId}`);
                                        const likeCount = document.querySelector(`#like-count-${postId}`);
                                        const icon = likeBtn.querySelector('i');
              
                                         if (data.liked) {
                                            icon.className = 'bi bi-heart-fill text-danger';
                                        } else {
                                            icon.className = 'bi bi-heart';
                                        }
                                        likeCount.textContent = `${data.likes} likes`;
                                    })
                                    .catch(error => {
                                      console.error('Error: ', error);
                                    })
                                  });
              
                                document.querySelectorAll('.comment-form').forEach(form => {
                                  form.addEventListener('submit', function(e) {
                                      e.preventDefault();
                                      const formData = new FormData(this);
                                      
                                      fetch(this.action, {
                                          method: 'POST',
                                          body: formData,
                                          headers: {
                                              'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                                          }
                                      })
                                      .then(response => {
                                          if (response.redirected) {
                                              window.location.href = response.url;
                                          }
                                      });
                                  });
                              });
              
              
                            });
                            </script>        
                        </div> 
                        </div>{% else %}
                                <p>The event is ongoing! Come back later to add posts and interact with other users!</p>
                              {% endif %}
                        </div>
                    </div> 
                </div> 

      
        <!-- {% include 'event_status_content.html' %} -->
      </div>
      
      <script>
        function checkEventStatus() {
            const eventElement = document.getElementById('event-status');
            const eventId = eventElement.dataset.eventId;
            const currentStatus = eventElement.dataset.currentStatus;

            fetch(`/event_status_api/${eventId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status !== eventElement.dataset.currentStatus) {
                      location.reload();
                    }
                });
        }
        
        setInterval(checkEventStatus, 60000);
        
        document.addEventListener('DOMContentLoaded', checkEventStatus);
      </script>

      <script>
        document.addEventListener('DOMContentLoaded', function(){
          const key = 'guestEventActiveTab_{{ event.id }}';

          const stored = localStorage.getItem(key);
          if(stored){
            const someTabTrigger = document.querySelector(`#eventTabs a[href="${stored}"]`);
            if(someTabTrigger){
              const tab = new bootstrap.Tab(someTabTrigger);
              tab.show();
            }
          }

          document.querySelectorAll('#eventTabs a[data-bs-toggle="pill"]').forEach(el=>{
            el.addEventListener('shown.bs.tab', function(e){
              localStorage.setItem(key, e.target.getAttribute('href'));
            });
          });
        });
      </script>
    </div>  
  </div>
        
</div>
<div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="staticBackdropLabel">Modal title</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Back</button>
       </div>
    </div>
  </div>
</div>
  <!-- Edit Dish Modal -->
<div class="modal fade" id="editDishModal" tabindex="-1" aria-labelledby="editDishLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editDishLabel">Choose another dish</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="dish-list" class="row g-3"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="save-dish-btn">Save selection</button>
      </div>
    </div>
  </div>
</div>


<script>
  // Global constants accessible to all functions
  const GLOBAL_MEDIA_URL = "{{ MEDIA_URL }}";
  const ALL_DISHES = JSON.parse('{{ all_dishes_json|escapejs }}');
  const GUEST_ALLERGENS = JSON.parse('{{ guest_allergens_json|escapejs }}');
  let chosenMenu = JSON.parse('{{ chosen_menu_json|escapejs }}');
  const selectedDishes = {};
  function syncSelectedDishes(){
      chosenMenu.forEach(d=>{ selectedDishes[d.category]=d.id; });
  }
  syncSelectedDishes();

  document.addEventListener('click', e=>{
        const btn=e.target.closest('.edit-choice');
        if(btn){
           console.log('cat:', btn.closest('tr').dataset.category);
           openEditModal(btn.closest('tr').dataset.category);
        }
     });

  // Delegated change handler for initial dish selection grid (generate-menu flow)
  document.addEventListener('change',function(e){
      if(!e.target.classList.contains('dish-option')) return;
      const radio=e.target;
      const cat = radio.name; // name attribute holds category in initial grid
      selectedDishes[cat]=parseInt(radio.value);

      const required=["appetizer","main","dessert","drink"];
      const allSelected=required.every(c=>selectedDishes[c]);

      const btnId='submit-menu-btn';
      let submitBtn=document.getElementById(btnId);
      if(allSelected && !submitBtn){
          submitBtn=document.createElement('button');
          submitBtn.id=btnId;
          submitBtn.className='btn btn-success mt-3';
          submitBtn.textContent='Save Menu';
          submitBtn.onclick=saveCurrentMenu;
          document.getElementById('submit-menu-container').appendChild(submitBtn);
      }else if(!allSelected && submitBtn){
          submitBtn.remove();
      }
  });

  function saveCurrentMenu(){
      const csrftoken=document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
      const dataDiv=document.getElementById('menu-data');
      const payload={
          event_id:dataDiv.dataset.eventId,
          location_id:dataDiv.dataset.locationId,
          menu_choices:Object.values(selectedDishes)
      };
      fetch('/save_guest_menu/',{
           method:'POST',
           headers:{'Content-Type':'application/json','X-CSRFToken':csrftoken},
           body:JSON.stringify(payload)
      }).then(r=>r.json()).then(d=>{
          if(d.success){
              Swal.fire('Saved','Your menu was saved successfully','success');
              buildMenuSummary(d.menu);
              document.getElementById('suggested-menu').classList.add('d-none');
          }else{
              Swal.fire('Error',d.error||'An error occurred','error');
          }
      }).catch(()=>Swal.fire('Error','Network error','error'));
  }

  function buildMenuSummary(menu){
    const container = document.getElementById('submit-menu-container');
    container.innerHTML='';
    const table=document.createElement('table');
    table.className='table table-bordered mt-3';
    table.innerHTML=`<thead><tr><th>Category</th><th>Image</th><th>Dish</th><th>Allergens</th><th>Diet</th><th>Action</th></tr></thead><tbody></tbody>`;
    const tbody=table.querySelector('tbody');

    menu.forEach(item=>{
      const tr=document.createElement('tr');
      tr.dataset.category=item.category.toLowerCase();
      const imgSrc = item.image || GLOBAL_MEDIA_URL + 'placeholder.jpg';
      tr.innerHTML=`<td class='text-capitalize'>${item.category}</td>
        <td><img src="${imgSrc}" onerror="this.src='${GLOBAL_MEDIA_URL}placeholder.png'" class="img-thumbnail" style="max-width:80px; max-height:80px; object-fit:cover;"></td>
        <td>${item.name}${item.region ? ', ' + item.region : ''}</td>
        <td>${item.allergens.length ? item.allergens.join(', ') : 'None'}</td>
        <td>${item.diet_type}</td>
        <td><button class='btn btn-sm btn-primary edit-choice'>Edit  <i class="bi bi-pencil-square"></i></button></td>`;
      tbody.appendChild(tr);
    });
    container.appendChild(table);

    const mc=document.getElementById('menu-configuration');
    if(mc) mc.style.display='none';
  }

  function openEditModal(category){
    category = category.toLowerCase(); // normalizează cheia
    console.log('category:', category);
    if(!ALL_DISHES[category]){
         console.error('No dishes list for category',category);
         Swal.fire('Error','No dishes available for '+category,'error');
         return;
     }
      const modal = new bootstrap.Modal(document.getElementById('editDishModal'));
      modal.show();
      const list = document.getElementById('dish-list');
      list.innerHTML='';
      console.log('ALL_DISHES:', ALL_DISHES);
      ALL_DISHES[category].forEach(dish=>{
          const unsafe = dish.allergens.some(al=>GUEST_ALLERGENS.includes(al));
          const col=document.createElement('div');
          col.className='col-md-4';
          col.innerHTML=`
              <div class="card h-100 border-2 ${unsafe?'border-danger':'border-success'}">
                  <img src="${dish.image || GLOBAL_MEDIA_URL+'placeholder.jpg'}" class="card-img-top" style="max-height:140px;object-fit:cover;">
                  <div class="card-body text-center">
                      <h6 class="card-title">${dish.name}</h6>
                      <span class="badge ${unsafe?'bg-danger':'bg-success'}">${unsafe?'Unsafe':'Safe'}</span>
                      <input type="radio" name="dish-choice" value="${dish.id}" class="form-check-input">
                  </div>
              </div>
          `;
          list.appendChild(col);
      });

      console.log('chosenMenu:', chosenMenu);
      const currentDish = chosenMenu.find(m=>m.category===category);
      if(currentDish){
         const radio = list.querySelector(`input[value='${currentDish.id}']`);
         if(radio) radio.checked = true;
      }

      // Save handler
      document.getElementById('save-dish-btn').onclick=function(){
          const selected = list.querySelector("input[name='dish-choice']:checked");
          if(!selected){Swal.fire('Select a dish first'); return;}
          const dishId=parseInt(selected.value);
          const dishObj = ALL_DISHES[category].find(d=>d.id===dishId);
          // Update chosenMenu array
          const idx = chosenMenu.findIndex(m=>m.category===category);
          if(idx>-1){
             chosenMenu[idx]={
               id:dishObj.id,
               name:dishObj.name,
               category:category,
               image:dishObj.image,
               allergens:dishObj.allergens,
               diet_type:dishObj.diet_type
             };
          }
          // update chosenMenu + table
          buildMenuSummary(chosenMenu);
          syncSelectedDishes();

          // if all categories selected, persist to server immediately
          const required=["appetizer","main","dessert","drink"];
          const allSelected = required.every(cat=>selectedDishes[cat]);
          if(allSelected){
              const csrftoken=document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
              const dataDiv=document.getElementById('menu-data');
              const payload={
                  event_id:dataDiv.dataset.eventId,
                  location_id:dataDiv.dataset.locationId,
                  menu_choices:Object.values(selectedDishes)
              };
              fetch('/save_guest_menu/',{
                  method:'POST',
                  headers:{'Content-Type':'application/json','X-CSRFToken':csrftoken},
                  body:JSON.stringify(payload)
              }).then(r=>r.json()).then(d=>{
                  if(d.success){ console.log('Menu saved'); }
              });
          }

          modal.hide();
      };
  }

  // Build menu table on first load so it appears after refresh
  document.addEventListener('DOMContentLoaded',()=>{
      if(Array.isArray(chosenMenu) && chosenMenu.length){
          buildMenuSummary(chosenMenu);
      }
  });
</script>

<script>
 document.addEventListener("DOMContentLoaded", () => {
   const rsvpStatus = "{{ rsvp.response }}";
   const key = `rsvpPromptDismissed_{{ event.id }}`;

   if (rsvpStatus === "Pending" && !sessionStorage.getItem(key)) {
     Swal.fire({
       title: "Do you want to participate?",
       text: "Please confirm your attendance.",
       icon: "question",
       showDenyButton: true,
       showCancelButton: true,
       confirmButtonText: "Accept",
       denyButtonText: "Decline",
       cancelButtonText: "Later"
     }).then(r => {
       if (r.isConfirmed) sendRsvp("Accepted");
       else if (r.isDenied) sendRsvp("Declined");
       else sessionStorage.setItem(key, "true");
     });
   }

  function getCookie(n){return document.cookie.split('; ').find(row=>row.startsWith(n+'='))?.split('=')[1];}
   function sendRsvp(val){
     fetch(location.pathname,{
       method:"POST",
       headers:{
         "Content-Type":"application/x-www-form-urlencoded",
         "X-CSRFToken":getCookie("csrftoken")
       },
       body:new URLSearchParams({response:val})
     }).then(()=>location.reload());
   }
 });
</script>

<!-- Disable interactions if event completed -->
<script>
document.addEventListener('DOMContentLoaded',function(){
  const generalTab=document.querySelector('#general');
  if(generalTab && generalTab.dataset.eventStatus==='completed'){
      const elements=generalTab.querySelectorAll('input, select, textarea, button');
      elements.forEach(el=>{
          el.setAttribute('disabled','disabled');
          el.classList.add('disabled');
      });
  }
});
</script>

{% endblock %}