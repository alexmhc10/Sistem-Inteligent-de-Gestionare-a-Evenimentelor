{% extends 'main.html' %}
{% block navbar %}
{% endblock %}


{% block content %}

<div class="page-wrapper" id="main-wrapper" data-layout="vertical" data-navbarbg="skin6" data-sidebartype="full"
data-sidebar-position="fixed" data-header-position="fixed">
<!-- Sidebar Start -->
  <aside class="left-sidebar">
    <!-- Sidebar scroll-->
    <div>
      <div class="brand-logo d-flex align-items-center justify-content-between">
        <a href="{% url 'guest_home' %}" class="text-nowrap logo-img">
          <img src="../static/images/image.png" class="mt-3" style="max-width: 100%; max-height: 100%;">
        </a>
        <div class="close-btn d-xl-none d-block sidebartoggler cursor-pointer" id="sidebarCollapse">
          <i class="ti ti-x fs-8"></i>
        </div>
      </div>
      <!-- Sidebar navigation-->
      <nav class="sidebar-nav scroll-sidebar" data-simplebar="">
        <ul id="sidebarnav">
          <li class="nav-small-cap">
            <i class="ti ti-dots nav-small-cap-icon fs-6"></i>
            <span class="hide-menu">Home</span>
          </li>
          <li class="sidebar-item">
            <a class="sidebar-link active ps-4" aria-expanded="false">
              <i class="bi bi-house"></i>
              <span class="hide-menu">Home</span>
            </a>
          </li>
          <li class="nav-small-cap">
            <i class="ti ti-dots nav-small-cap-icon fs-6"></i>
            <span class="hide-menu">About you</span>
          </li>
          <li class="sidebar-item">
              <a class="sidebar-link ps-4" href="{% url 'guest_profile' %}" aria-expanded="false">
                <i class="bi bi-person-fill"></i>
              <span class="hide-menu">Profile</span>
            </a>
          </li>
        </ul>
      </nav>
      <!-- End Sidebar navigation -->
    </div>
    <!-- End Sidebar scroll-->
  </aside>
  <!--  Sidebar End -->
  <!--  Main wrapper -->
  <div class="body-wrapper">
    <!--  Header Start -->
    <header class="app-header">
      <nav class="navbar navbar-expand-lg navbar-light">
        <ul class="navbar-nav">
          <li class="nav-item d-block d-xl-none">
            <a class="nav-link sidebartoggler nav-icon-hover" id="headerCollapse" href="javascript:void(0)">
              <i class="ti ti-menu-2"></i>
            </a>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link nav-icon-hover" href="#" id="notificationDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-bell-fill"></i>              
              <div id="notification-badge" class="notification bg-primary rounded-circle d-none"></div>
            </a>
            <ul class="dropdown-menu p-2" aria-labelledby="notificationDropdown" id="notification-list">
                <li class="dropdown-header">Notifications</li>
                <li><hr class="dropdown-divider"></li>
                <li class="text-center"><small>You got no notifications</small></li>
            </ul>
        </li>
        <script>
          document.addEventListener("DOMContentLoaded", function () {
          const notificationButton = document.getElementById("notificationDropdown");
          const notificationList = document.getElementById("notification-list");
          const notificationBadge = document.getElementById("notification-badge");

          function fetchNotifications() {
              fetch("/get_notifications/")
                  .then(response => response.json())
                  .then(data => {
                      notificationList.innerHTML = '<li class="dropdown-header">Notifications</li><li><hr class="dropdown-divider"></li>';
                      
                      if (data.notifications && data.notifications.length > 0) {
                          data.notifications.forEach(notification => {
                              const listItem = document.createElement("li");
                              const eventId = notification.event_id;
                                const eventUrl = `/guest_event_view/${eventId}`;
                              listItem.innerHTML = `<a class="dropdown-item" href="${eventUrl}">${notification.message} <small class="text-muted">(${notification.timestamp})</small></a>`;
                              notificationList.appendChild(listItem);
                          });
                          notificationBadge.classList.remove("d-none");
                      } else {
                          notificationList.innerHTML += '<li class="text-center"><small>You got no notifications</small></li>';
                          notificationBadge.classList.add("d-none");
                      }
                  })
                  .catch(error => console.error("Error:", error));
          }
          notificationButton.addEventListener("click", fetchNotifications);
          
          setInterval(fetchNotifications, 10000);
          });
        </script>
        </ul>
        <div class="navbar-collapse justify-content-end px-0" id="navbarNav">
          <ul class="navbar-nav flex-row ms-auto align-items-center justify-content-end">
            <li class="nav-item dropdown">
              <a class="nav-link nav-icon-hover" href="javascript:void(0)" id="drop2" data-bs-toggle="dropdown"
                aria-expanded="false">
                <img src="{{ MEDIA_URL }}{{ profile.photo }}" alt="Ceva" width="35" height="35" class="rounded-circle">
              </a>
              <div class="dropdown-menu dropdown-menu-end dropdown-menu-animate-up" aria-labelledby="drop2">
                <div class="message-body">
                  <a href="{% url 'guest_profile' %}" class="d-flex align-items-center gap-2 dropdown-item">
                    <i class="ti ti-user fs-6"></i>
                    <p class="mb-0 fs-3">My Profile</p>
                  </a>
                  <a href="{% url 'logout' %}" class="btn btn-outline-primary mx-3 mt-2 d-block">Logout</a>
                </div>
              </div>
            </li>
          </ul>
        </div>
      </nav>
    </header>
    <div class="container-sm">
      <div class="row">
        <div class="col-lg-8 offset-lg-2">
          <div class="card">
              <div class="card-body d-flex flex-column">
                  <div class="card-title h1 text-center">Checkout the details about the event!</div>   
                  <div class="title text-center"><p class="h2 fs-5">{{event.event_name}}</p></div>             
              </div>
          </div>
          <div class="card">
              <div class="card-body">
                  <div class="image d-flex justify-content-center">
                      <img src="{{MEDIA_URL}}{{ event.location.gallery }}" alt="" srcset="" class="img-fluid" style="max-height: 300px;">
                  </div>
                  <div class="row mt-4">
                      <div class="col-lg-6 border border-secondary-subtle">
                          <h3 class="text-center">Time to start</h3>
                          <div class="event">
                              <p id="countdown-{{ event.id }}"></p>
                          </div>
                          <script>
                              var events = {{ event_data|safe }};
                              
                              events.forEach(function(event) {
                                  var eventDate = new Date(event.event_date).getTime();
                                  var countdownElement = document.getElementById("countdown-" + event.id);
                                  
                                  function updateCountdown() {
                                      var now = new Date().getTime();
                                      var timeLeft = eventDate - now;
                      
                                      var days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                                      var hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                                      var minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                                      var seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                      
                                      if (timeLeft > 0) {
                                          countdownElement.innerHTML = `${days} days, ${hours} hours, ${minutes} minutes, ${seconds} seconds`;
                                      } else {
                                          countdownElement.innerHTML = "The event its live!";
                                      }
                                  }
                      
                                  updateCountdown(); 
                                  setInterval(updateCountdown, 1000);
                              });
                          </script>
                      </div>
                      <div class="col-lg-6">
                          <h3 class="text-center">Location data</h3>
                          
                      </div>
                      <div class="col-lg-6 d-flex flex-column justify-content-center text-center" style="min-height: 200px;">
                          <h3 class="text-center">Preferences</h3>
                          <div class="row d-flex flex-row">
                            <div class="col-3 d-flex flex-column text-center">
                              <i class="bi bi-cup-hot text-center"></i>
                              <p>Cuisine</p>
                              <p>{{ preferences.cuisine_preference }}</p>
                            </div>
                            <div class="col-3 d-flex flex-column text-center">
                              <i class="bi bi-flower1"></i>
                              <p>Vegan</p>
                              {% if preferences.vegan %}
                              <i class="bi bi-check-lg"></i>

                              {% else %}
                              <i class="bi bi-x-lg"></i>

                              {% endif %}
                            </div>
                            <div class="col-3 d-flex flex-column text-center">
                              <i class="bi bi-virus"></i>
                              <p>Alergens</p>
                              <p>{{ preferences.allergens|join:", " }}</p>
                            </div>
                            <div class="col-3 d-flex flex-column text-center">
                              <i class="bi bi-file-person"></i>
                              <p>Age</p>
                              <p>{{ preferences.age }}</p>
                            </div>
                    
                          </div>
                            <a href="{% url 'guest_profile' %}" class="btn btn-primary">Change preferences</a>
                      </div>
                      <div class="col-lg-6">
                          <h3 class="text-center">Attendence status</h3>
                          <div class="status d-flex flex-row gap-2 align-items-center">
                            <p class="h2 fs-4">Your current status: </p>
                            <a href="" class="btn btn-secondary me-auto">{{ rsvp.response }}</a>
                          </div>
                          <div class="change-btn mt-4 justify-content-end"></div>
                            <form action="" method="POST">
                              {% csrf_token %}
                              {% if rsvp.response == "Accepted" %}
                              <button type="submit" name="response" value="Declined" class="btn btn-danger" onclick="confirmPresence(event, 'cancel')">Cancel presence!</button>
                              {% elif rsvp.response == "Pending" or rsvp.response == "Declined" %}
                              <button type="submit" name="response" value="Accepted" class="btn btn-warning" onclick="confirmPresence(event, 'confirm')">Confirm presence!</button>
                              {% endif %}
                            </form>
                      </div>
                      <script>
                        function confirmPresence(event, action) {
                            event.preventDefault();

                            let message = (action === 'confirm') 
                                ? "Are you sure that you want to atend to the event?"
                                : "Are you sure that you want to cancel the attendance?";
                            
                                Swal.fire({
                                    title: "Confirmation",
                                    text: message,
                                    icon: "warning",
                                    showCancelButton: true,
                                    confirmButtonText: "Yes",
                                    cancelButtonText: "No",
                                }).then((result) => {
                                    if (result.isConfirmed) {
                                        let form = event.target.closest("form");
                                        let input = document.createElement("input");
                                        input.type = "hidden";
                                        input.name = "response";
                                        input.value = (action === 'confirm') ? "Accepted" : "Declined";
                                        form.appendChild(input);
                                        form.submit();
                                    }
                                });
                        }
                      </script>
                  </div>
              </div>
          </div>
        </div>
      </div>  
    </div>
        
    </div>
  </div>
</div>
{% endblock %}