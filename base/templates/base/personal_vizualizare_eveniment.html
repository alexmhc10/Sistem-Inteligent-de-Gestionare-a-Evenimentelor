{% extends 'main.html' %}
{% block navbar %}
{% endblock %}

{% block content %}
<style>
    .glow-text {
  color: white;
  text-shadow: 
      0 0 5px #fff,
      0 0 10px #fff,
      0 0 20px #deb6b6,
      0 0 50px #b9e1db;
  font-weight: bold;
  text-align: center;
}
</style>

<div class="page-wrapper" id="main-wrapper" data-layout="vertical" data-navbarbg="skin6" data-sidebartype="full"
data-sidebar-position="fixed" data-header-position="fixed">
    <!-- Sidebar Start -->
    <aside class="left-sidebar">
    <!-- Sidebar scroll-->
    <div>
        <div class="brand-logo d-flex align-items-center justify-content-between">
        <a href="{% url 'personal_eveniment_home' %}" class="text-nowrap logo-img">
            <img src="../static/images/image.png" class="mt-3" style="max-width: 100%; max-height: 100%;">
        </a>
        <div class="close-btn d-xl-none d-block sidebartoggler cursor-pointer" id="sidebarCollapse">
            <i class="ti ti-x fs-8"></i>
        </div>
        </div>
        <!-- Sidebar navigation-->
        <nav class="sidebar-nav scroll-sidebar" data-simplebar="">
        <ul id="sidebarnav">
            <li class="nav-small-cap">
            <i class="ti ti-dots nav-small-cap-icon fs-6"></i>
            <span class="hide-menu">Home</span>
            </li>
            <li class="sidebar-item">
            <a class="sidebar-link ps-4" href="{% url 'personal_eveniment_home' %}  " aria-expanded="false">
                <i class="bi bi-house-fill"></i>

                <span class="hide-menu">Home</span>
            </a>
            </li>
            <li class="nav-small-cap">
            <i class="ti ti-dots nav-small-cap-icon fs-6"></i>
            <span class="hide-menu">Managing tools</span>
            </li>
            <li class="sidebar-item">
            <a class="sidebar-link" href="{% url 'personal_aranjament_invitati_event' event.id %}" aria-expanded="false">
                <span>
                <iconify-icon icon="solar:layers-minimalistic-bold-duotone" class="fs-6"></iconify-icon>
                </span>
                <span class="hide-menu">Layout</span>
            </a>
            </li>
            <li class="sidebar-item">
                <a class="sidebar-link" href="{% url 'personal_face_id' event.id%}" aria-expanded="false">
                <span>
                    <iconify-icon icon="solar:layers-minimalistic-bold-duotone" class="fs-6"></iconify-icon>
                </span>
                <span class="hide-menu">Face ID</span>
                </a>
            </li>
            <li class="nav-small-cap">
                <i class="ti ti-dots nav-small-cap-icon fs-6"></i>
                <span class="hide-menu">Account</span>
              </li>
              <li class="sidebar-item">
                <a class="sidebar-link ps-4" href="{% url 'personal_profile' %}" aria-expanded="false">
                  <i class="bi bi-person-fill"></i>
                <span class="hide-menu">Profile</span>
              </a>
            </li>
        </ul>
        </nav>
        <!-- End Sidebar navigation -->
    </div>
    <!-- End Sidebar scroll-->
    </aside>
    <!--  Sidebar End -->
    <!--  Main wrapper -->
    <div class="body-wrapper">
    <!--  Header Start -->
    <header class="app-header">
        <nav class="navbar navbar-expand-lg navbar-light">
        <ul class="navbar-nav">
            <li class="nav-item d-block d-xl-none">
            <a class="nav-link sidebartoggler nav-icon-hover" id="headerCollapse" href="javascript:void(0)">
                <i class="ti ti-menu-2"></i>
            </a>
            </li>
            <li class="nav-item dropdown">
                <a class="nav-link nav-icon-hover" href="#" id="notificationDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="bi bi-bell-fill"></i>              
                  <div id="notification-badge" class="notification bg-primary rounded-circle d-none"></div>
                </a>
                <ul class="dropdown-menu p-2" aria-labelledby="notificationDropdown" id="notification-list">
                    <li class="dropdown-header">Notifications</li>
                    <li><hr class="dropdown-divider"></li>
                    <li class="text-center"><small>You got no notifications</small></li>
                </ul>
            </li>
            <script>
              document.addEventListener("DOMContentLoaded", function () {
              const notificationButton = document.getElementById("notificationDropdown");
              const notificationList = document.getElementById("notification-list");
              const notificationBadge = document.getElementById("notification-badge");

              function fetchNotifications() {
                  fetch("/get_notifications/")
                      .then(response => response.json())
                      .then(data => {
                          notificationList.innerHTML = '<li class="dropdown-header">Notifications</li><li><hr class="dropdown-divider"></li>';
                          
                          if (data.notifications && data.notifications.length > 0) {
                              data.notifications.forEach(notification => {
                                  const listItem = document.createElement("li");
                                  const eventId = notification.event_id;
                                    const eventUrl = `/personal_vizualizare_eveniment/${eventId}`;
                                  listItem.innerHTML = `<a class="dropdown-item" href="${eventUrl}">${notification.message} <small class="text-muted">(${notification.timestamp})</small></a>`;
                                  notificationList.appendChild(listItem);
                              });
                              notificationBadge.classList.remove("d-none");
                          } else {
                              notificationList.innerHTML += '<li class="text-center"><small>You got no notifications</small></li>';
                              notificationBadge.classList.add("d-none");
                          }
                      })
                      .catch(error => console.error("Error:", error));
              }
              notificationButton.addEventListener("click", fetchNotifications);
              
              setInterval(fetchNotifications, 10000);
              });
            </script>
        </ul>
        <div class="navbar-collapse justify-content-end px-0" id="navbarNav">
            <ul class="navbar-nav flex-row ms-auto align-items-center justify-content-end">
            <li class="nav-item dropdown">
                <a class="nav-link nav-icon-hover" href="javascript:void(0)" id="drop2" data-bs-toggle="dropdown"
                aria-expanded="false">
                <img src="{{ MEDIA_URL }}{{ event.location.gallery }}" alt="" width="35" height="35" class="rounded-circle">
                </a>
                <div class="dropdown-menu dropdown-menu-end dropdown-menu-animate-up" aria-labelledby="drop2">
                <div class="message-body">
                    <a href="{% url 'personal_profile' %}" class="d-flex align-items-center gap-2 dropdown-item">
                    <i class="ti ti-user fs-6"></i>
                    <p class="mb-0 fs-3">My Profile</p>
                    </a>
                    <a href="{% url 'logout' %}" class="btn btn-outline-primary mx-3 mt-2 d-block">Logout</a>
                </div>
                </div>
            </li>
            </ul>
        </div>
        </nav>
    </header>
    <!--  Header End -->
    <div class="container-fluid">
        <div class="row">

        <div class="col-lg-8">
            <div class="row d-flex flex-column flex-wrap">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-body">
                            <h1 class="card-title d-flex align-items-center gap-2">
                                {{ event.event_name }}! 
                            </h1>
                            <div class="d-flex align-items-center gap-4 mt-4">
                                <div class="d-flex align-items-center gap-2">
                                <i class="ti ti-eye text-dark fs-5"></i>{{ event.guests.count }} guests
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                <i class="ti ti-message-2 text-dark fs-5"></i> {{event.location.seats_numbers}} seats
                                </div>
                                <div class="d-flex align-items-center fs-2 ms-auto">
                                <i class="ti ti-point text-dark"></i>{{ event.event_date }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-body">
                            <h1 class="card-title">Time left:</h1>
                            <div class="event">
                                <p id="countdown-{{ event.id }}"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>    
        </div>
        <script type="application/json" id="next-event-data">
            {{ next_event_data|safe }}
        </script>
        <script>
            var eventData = JSON.parse(document.getElementById("next-event-data").textContent);
        
            if (event) {
                var eventDate = new Date(event.event_date).getTime();
                var countdownElement = document.getElementById("countdown-" + event.id);
        
                function updateCountdown() {
                    var now = new Date().getTime();
                    var timeLeft = eventDate - now;
        
                    var days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                    var hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    var minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                    var seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
        
                    if (timeLeft > 0) {
                        countdownElement.innerHTML = `${days} days, ${hours} hours, ${minutes} minutes, ${seconds} seconds`;
                    } else {
                        countdownElement.innerHTML = "The event is live!";
                    }
                }
        
                updateCountdown(); 
                setInterval(updateCountdown, 1000);
            }
        </script>
        
        <div class="col-lg-4">
            <div class="card">
                <img src="{{ MEDIA_URL }}{{ event.location.gallery }}" class="card-img" style="max-height: 300px; object-fit: cover;">
                <div class="card-img-overlay"></div>
            </div>
        </div>

        <div class="col-lg-12">
            <div class="card">
                <div class="card-body">
                    <h1 class="card-title d-flex align-items-center justify-content-center mb-0">
                        Event management and tools!
                    </h1>
                </div>
            </div>
        </div>
        <video id="camera" autoplay playsinline style="display:none;"></video>
        <canvas id="canvas" style="display:none;"></canvas>
        <button id="capture">Photo</button>
        

        <div class="col-lg-12">
            <div class="d-flex">
                <button class="btn btn-primary" id="launch_camera">Scan guests</button>
            </div>
        </div>

        <script>
        //     const video = document.getElementById('camera');

        //     async function startCamera() {
        //     try {
        //         const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
        //         video.srcObject = stream;
        //     } catch (error) {
        //         console.error("Eroare la accesarea camerei:", error);
        //         alert("Nu s-a putut accesa camera. Asigură-te că ai acordat permisiunea.");
        //     }
        // }
        document.getElementById("launch_camera").addEventListener("click", function() {
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(function(stream) {
                        let video = document.getElementById("camera");
                        video.srcObject = stream;
                        video.play();
                    })
                    .catch(function(error) {
                        console.error("Camera error:", error);
                    });
            });

        </script>

        <div class="col-lg-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Guest list</h5>
                        <div class="table-responsive">
                            <table class="table text-nowrap align-middle mb-0">
                            <thead>
                                <tr class="border-2 border-bottom border-primary justify-content-center border-0">
                                    <th scope="col" class="ps-0 text-center">Id</th>
                                    <th scope="col" class="ps-0 text-center">Full name</th>
                                    <th scope="col" class="text-center">Status</th>
                                    <th scope="col" class="text-center">Arriving time</th>
                                    <th scope="col" class="text-center">Gender</th>
                                    <th scope="col" class="text-center">Cuisine preference</th>
                                    <th scope="col" class="text-center">Vegan</th>
                                    <th scope="col" class="text-center">Allergens</th>
                                    <th scope="col" class="text-center">Table no.</th>
                                </tr>
                            </thead>
                            <tbody class="table-group-divider">
                                {% for response in rspv %}
                                <tr>
                                    <td class="ps-0 fw-medium"><span>{{ forloop.counter }}.</span></td>
                                    <td><span>{{ response.guest.profile_set.all.0.first_name }}</span></td>
                                    <td class="text-center fw-medium"><span class="badge bg-success-subtle text-success text-uppercase">Confirmed</span></td>
                                    <td class="text-center fw-medium">22:31</td>
                                    <td class="text-center fw-medium">{{ response.guest.profile_set.all.0.guest_profile.gender }}</td>
                                    <td class="text-center fw-medium">{{ response.guest.profile_set.all.0.guest_profile.cuisine_preference }}</td>
                                    {% if response.guest.profile_set.all.0.guest_profile.vegan %}
                                    <td class="text-center fw-medium">Yes</td>
                                    {% else %}
                                    <td class="text-center fw-medium">No</td>
                                    {% endif %}
                                    <td class="text-center fw-medium">{{ response.guest.profile_set.all.0.guest_profile.allergens|join:", " }}</td>
                                    <td class="text-center fw-medium">Table x</td>
                                </tr>
                                {% endfor %}
                            </tbody>

                            </table>
                        </div>
                    </div>
                </div>
        </div>
        <div class="col-lg-4 h-100">
            <div class="row gap gap-4">
                <div class="col-lg-12">
                    <div class="card card-hover h-100">
                            <div class="card-header">No. of guests arrived!</div>
                                <div class="card-body d-flex align-items-center p-4 fs-5 gap-4">
                                        <div class="d-flex align-items-center me-auto">
                                        <i class="ti ti-eye text-dark fs-5"></i>{{ event.guests.count }}
                                        </div>
                                        <div class="d-flex align-items-center me-auto">
                                            <i class="ti ti-message-2 text-dark fs-5"></i>/
                                        </div>
                                        <div class="d-flex align-items-center me-auto">
                                        <i class="ti ti-message-2 text-dark fs-5"></i> {{event.location.seats_numbers}}
                                        </div>
                                </div>
                    </div>
                </div>
                <div class="col-lg-12">
                    <div class="card card-hover h-100">
                        <div class="card-header">Time until the event starts!</div>
                            <div class="card-body d-flex align-items-center justify-content-center p-2 fs-5 gap-3">
                                <div class="d-flex align-items-center me-auto">
                                    <i class="ti ti-eye text-dark fs-5 ml-2"></i>{{ event.event_time }}
                                    </div>
                                    <div class="d-flex align-items-center me-auto">
                                        <i class="ti ti-message-2 text-dark fs-5"></i>/
                                    </div>
                                    <div class="d-flex align-items-center me-auto">
                                    <i class="ti ti-message-2 text-dark fs-5"></i> local time
                                    </div>
                            </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4 offset-lg-4">
            <div class="card">
                <div class="card-body">
                    <h1 class="card-title">Send a notification</h1>
                    <form action="{% url 'send_notification' %}" method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input type="hidden" name="event_id" value="{{ event.id }}">
                        <label for="receiver">To:</label>
                        <select class="form-control mb-2" name="receiver" id="receiver">
                            <option value="organizer">The organiser</option>
                            <option value="everyone">Organiser and guests</option>
                        </select>
                        <textarea class="form-control mb-2" name="message" id="message" cols="30" rows="5"></textarea>
                        <button type="submit" name="submit" class="btn btn-primary">Send</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    </div>
    </div>
</div> 
{% endblock content %}

{% block javascript %}
<script>
    scrollToBottom();

    const instance = new mdb.Datatable(document.getElementById('datatable'), data)

document.getElementById('datatable-search-input').addEventListener('input', (e) => {
  instance.search(e.target.value);
});
</script>
{% endblock javascript %}
