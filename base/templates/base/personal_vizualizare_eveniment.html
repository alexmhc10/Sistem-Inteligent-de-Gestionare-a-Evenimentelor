{% extends 'main.html' %}
{% block navbar %}
{% endblock %}


{% block content %}
<style>
    .glow-text {
        color: white;
        text-shadow: 
            0 0 5px #fff,
            0 0 10px #fff,
            0 0 20px #deb6b6,
            0 0 50px #b9e1db;
        font-weight: bold;
        text-align: center;
    }
    .not-visible {
        display: none;
    }
    .visible{
        display: block;
    }
</style>

<div class="page-wrapper" id="main-wrapper" data-layout="vertical" data-navbarbg="skin6" data-sidebartype="full"
data-sidebar-position="fixed" data-header-position="fixed">
    <!-- Sidebar Start -->
    {% include 'sidebar.html' %}
    <!--  Main wrapper -->
    <div class="body-wrapper">
    <!--  Header Start -->
    {% include 'header.html' %}

    <div class="container-fluid">
        <div class="row">

        <div class="col-lg-6">
            <div class="row d-flex flex-column flex-wrap">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-body">
                            <h1 class="card-title d-flex align-items-center gap-2">
                                {{ event.event_name }}! 
                            </h1>
                            <div class="d-flex align-items-center gap-4 mt-4">
                                <div class="d-flex align-items-center gap-2">
                                <i class="ti ti-eye text-dark fs-5"></i>{{ event.guests.count }} guests
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                <i class="ti ti-message-2 text-dark fs-5"></i> {{event.location.seats_numbers}} seats
                                </div>
                                <div class="d-flex align-items-center fs-2 ms-auto">
                                <i class="ti ti-point text-dark"></i>{{ event.event_date }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-body">
                            <h1 class="card-title d-flex align-items-center gap-2">Time left until event start!</h1>
                            {% include 'timer.html' %}
                        </div>
                    </div>
                </div>
            </div>    
        </div>
        
        <div class="col-lg-3">
            <div class="card">
                <img src="{{ MEDIA_URL }}{{ event.location.gallery }}" class="card-img" style="max-height: 300px; object-fit: cover;">
                <div class="card-img-overlay"></div>
            </div>
        </div>

        <div class="col-lg-3">
            <div class="card">
                <div class="card-body">
                    <h1 class="card-title">Send a notification</h1>
                    <form action="{% url 'send_notification' %}" method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input type="hidden" name="event_id" value="{{ event.id }}">
                        <label for="receiver">To:</label>
                        <select class="form-control mb-2" name="receiver" id="receiver">
                            <option value="organizer">The organiser</option>
                            <option value="everyone">Organiser and guests</option>
                        </select>
                        <textarea class="form-control mb-2" name="message" id="message" cols="30" rows="5"></textarea>
                        <button type="submit" name="submit" class="btn btn-primary">Send</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-12">
            <div class="card">
                <div class="card-body">
                    <h1 class="card-title d-flex align-items-center justify-content-center mb-0">
                        Event management and tools!
                    </h1>
                </div>
            </div>
        </div>
        <video id="video-element" style="display: none;" autoplay playsinline></video>
        <div id="img-element"></div>
        <div class="d-flex flex-row justify-content-center mb-4 gap-2">
            <button id="capture-btn" class="btn btn-primary">Photo</button>
            <button id="reload-btn" class="btn btn-secondary">Retry</button>  
            <button class="btn btn-primary scan" id="launch_camera">Scan guests</button>
        </div>

        <script>

        $(".scan").click(function () {
            const eventId = "{{ event.id }}"; 
            $.ajax({
                url: `/scan/${eventId}/`,  // event_id Ã®n URL
                type: "POST",
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function(response) {
                    console.log("Scan success:", response);
                }
            });
        });

        </script>

        <!-- <video id="video" autoplay></video> -->



        <!-- <script>
            $(".scan").click(function () {
                const eventId = "{{event.id}}";
                $.ajax({
                    url: `/scan/${eventId}/`, 
                    type: "POST",
                    data: {
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                    },
                     success: function(response) {
                        console.log("Success", response);
                    },
                    error: function(xhr, status, error) {
                        console.error("Error AJAX:", xhr.responseText);
                    }
                });
            });
        </script> -->

        <div class="col-lg-12">
            <div class="d-flex">
                
            </div>
        </div>

        <!-- <script>

        // document.getElementById("launch_camera").addEventListener("click", function() {
        //         navigator.mediaDevices.getUserMedia({ video: true })
        //              .then(function(stream) {
        //                  let video = document.getElementById("video-element");
        //                 video.srcObject = stream;
        //                 video.play();
        //                 video.classList.add('visible');
        //              })
        //              .catch(function(error) {
        //                  console.error("Camera error:", error);
        //             });
        //      });

        console.log('hello world')

        const getCookie = (name) => {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const csrftoken = getCookie('csrftoken');

        const video = document.getElementById('video-element')
        const image = document.getElementById('img-element')
        const captureBtn = document.getElementById('capture-btn')
        const reloadBtn = document.getElementById('reload-btn')

        reloadBtn.addEventListener('click', () => {
            window.location.reload()
        })

        document.getElementById("launch_camera").addEventListener("click", function() {
            if (navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({video: true})
                .then((stream) => {
                    video.style.display = "block";
                    video.srcObject = stream
                    video.play();
                    const {height, width} = stream.getTracks()[0].getSettings()

                    captureBtn.addEventListener('click', e=> {
                        e.preventDefault()
                        captureBtn.classList.add('not-visible')
                        video.style.display = "none";
                        const track = stream.getVideoTracks()[0]
                        const imageCapture = new ImageCapture(track)
                        console.log(imageCapture)

                        imageCapture.takePhoto().then(blob => {
                            console.log("took photo:", blob)
                            const img = new Image(width, height)
                            img.src = URL.createObjectURL(blob)
                            image.append(img)

                            video.classList.add('not-visible')

                            const reader = new FileReader()

                            reader.readAsDataURL(blob)
                            reader.onloadend = () => {
                                const base64data = reader.result
                                console.log(base64data)

                                const fd = new FormData()
                                fd.append('csrfmiddlewaretoken', csrftoken)
                                fd.append('photo', base64data)

                                $.ajax({
                                    type: 'POST',
                                    url: '/classify/',
                                    enctype: 'multipart/form-data',
                                    data: fd,
                                    processData: false,
                                    contentType: false,
                                    success: (resp) => {
                                        console.log(resp)
                                    },
                                    error: (err) => {
                                        console.log(err)
                                    }
                                })
                            }
                        }).catch(error => {
                            console.log('takePhoto() error: ', error);
                        });
                    });
                })
                .catch(error => {
                    console.log("Something went wrong!", error);
                });
            }
        });

        </script> -->

        <div class="col-lg-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Guest list</h5>
                        <div class="table-responsive">
                            <table class="table text-nowrap align-middle mb-0">
                            <thead>
                                <tr class="border-2 border-bottom border-primary justify-content-center border-0">
                                    <th scope="col" class="ps-0 text-center">Id</th>
                                    <th scope="col" class="text-center">Photo</th>
                                    <th scope="col" class="ps-0 text-center">Full name</th>
                                    <th scope="col" class="text-center">Status</th>
                                    <th scope="col" class="text-center">Arriving time</th>
                                    <th scope="col" class="text-center">Gender</th>
                                    <th scope="col" class="text-center">Cuisine preference</th>
                                    <th scope="col" class="text-center">Vegan</th>
                                    <th scope="col" class="text-center">Allergens</th>
                                    <th scope="col" class="text-center">Table no.</th>
                                </tr>
                            </thead>
                            <tbody class="table-group-divider">
                                {% for response in rspv %}
                                <tr>
                                    <td class="ps-0 fw-medium"><span>{{ forloop.counter }}.</span></td>
                                    <td class="text-center fw-medium"><img src="{{MEDIA_URL}}{{ response.guest.profile_set.all.0.photo }}" class="rounded-circle" width="35" height="35"></td>
                                    <td><span>{{ response.guest.profile_set.all.0.first_name }}</span></td>
                                    <td class="text-center fw-medium"><span class="badge bg-success-subtle text-success text-uppercase">Confirmed</span></td>
                                    <td class="text-center fw-medium">22:31</td>
                                    <td class="text-center fw-medium">{{ response.guest.profile_set.all.0.guest_profile.gender }}</td>
                                    <td class="text-center fw-medium">{{ response.guest.profile_set.all.0.guest_profile.cuisine_preference }}</td>
                                    {% if response.guest.profile_set.all.0.guest_profile.vegan %}
                                    <td class="text-center fw-medium">Yes</td>
                                    {% else %}
                                    <td class="text-center fw-medium">No</td>
                                    {% endif %}
                                    <td class="text-center fw-medium">{{ response.guest.profile_set.all.0.guest_profile.allergens|join:", " }}</td>
                                    <td class="text-center fw-medium">Table x</td>
                                </tr>
                                {% endfor %}
                            </tbody>

                            </table>
                        </div>
                    </div>
                </div>
        </div>
        <!-- <div class="col-lg-4 h-100">
            <div class="row gap gap-4">
                <div class="col-lg-12">
                    <div class="card card-hover h-100">
                            <div class="card-header">No. of guests arrived!</div>
                                <div class="card-body d-flex align-items-center p-4 fs-5 gap-4">
                                        <div class="d-flex align-items-center me-auto">
                                        <i class="ti ti-eye text-dark fs-5"></i>{{ event.guests.count }}
                                        </div>
                                        <div class="d-flex align-items-center me-auto">
                                            <i class="ti ti-message-2 text-dark fs-5"></i>/
                                        </div>
                                        <div class="d-flex align-items-center me-auto">
                                        <i class="ti ti-message-2 text-dark fs-5"></i> {{event.location.seats_numbers}}
                                        </div>
                                </div>
                    </div>
                </div>
                <div class="col-lg-12">
                    <div class="card card-hover h-100">
                        <div class="card-header">Time until the event starts!</div>
                            <div class="card-body d-flex align-items-center justify-content-center p-2 fs-5 gap-3">
                                <div class="d-flex align-items-center me-auto">
                                    <i class="ti ti-eye text-dark fs-5 ml-2"></i>{{ event.event_time }}
                                    </div>
                                    <div class="d-flex align-items-center me-auto">
                                        <i class="ti ti-message-2 text-dark fs-5"></i>/
                                    </div>
                                    <div class="d-flex align-items-center me-auto">
                                    <i class="ti ti-message-2 text-dark fs-5"></i> local time
                                    </div>
                            </div>
                    </div>
                </div>
            </div>
        </div> -->
        
    </div>
    </div>
    </div>
</div> 
{% endblock content %}

{% block javascript %}

{% endblock javascript %}
