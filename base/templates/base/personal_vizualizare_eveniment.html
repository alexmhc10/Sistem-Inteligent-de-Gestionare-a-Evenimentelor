{% extends 'main.html' %}
{% block navbar %}
{% endblock %}


{% block content %}
<style>
    .glow-text {
        color: white;
        text-shadow: 
            0 0 5px #fff,
            0 0 10px #fff,
            0 0 20px #deb6b6,
            0 0 50px #b9e1db;
        font-weight: bold;
        text-align: center;
    }
    .not-visible {
        display: none;
    }
    .visible{
        display: block;
    }
</style>

<div class="page-wrapper" id="main-wrapper" data-layout="vertical" data-navbarbg="skin6" data-sidebartype="full"
data-sidebar-position="fixed" data-header-position="fixed">
    <!-- Sidebar Start -->
    {% include 'sidebar.html' %}
    <!--  Main wrapper -->
    <div class="body-wrapper">
    <!--  Header Start -->
    {% include 'header.html' %}

    <div class="container-fluid">
        <div class="row">

        <div class="col-lg-6">
            <div class="row d-flex flex-column flex-wrap">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-body">
                            <h1 class="card-title d-flex align-items-center gap-2">
                                {{ event.event_name }}! 
                            </h1>
                            <div class="d-flex align-items-center gap-4 mt-4">
                                <div class="d-flex align-items-center gap-2">
                                <i class="ti ti-eye text-dark fs-5"></i>{{ event.guests.count }} guests
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                <i class="ti ti-message-2 text-dark fs-5"></i> {{event.location.seats_numbers}} seats
                                </div>
                                <div class="d-flex align-items-center fs-2 ms-auto">
                                <i class="ti ti-point text-dark"></i>{{ event.event_date }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-body">
                            <h1 class="card-title text-center">Time left until event start!</h1>
                            {% include 'timer.html' %}
                        </div>
                    </div>
                </div>
            </div>    
        </div>
        
        <div class="col-lg-3">
            <div class="card">
                <img src="{{ MEDIA_URL }}{{ event.location.gallery }}" class="card-img" style="max-height: 300px; object-fit: cover;">
                <div class="card-img-overlay"></div>
            </div>
        </div>

        <div class="col-lg-3">
            <div class="card">
                <div class="card-body">
                    <h1 class="card-title">Send a notification</h1>
                    <form action="{% url 'send_notification' %}" method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input type="hidden" name="event_id" value="{{ event.id }}">
                        <label for="receiver">To:</label>
                        <select class="form-control mb-2" name="receiver" id="receiver">
                            <option value="organizer">The organiser</option>
                            <option value="everyone">Organiser and guests</option>
                        </select>
                        <textarea class="form-control mb-2" name="message" id="message" cols="30" rows="5"></textarea>
                        <button type="submit" name="submit" class="btn btn-primary">Send</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-12">
            <div class="card">
                <div class="card-body">
                    <h1 class="card-title d-flex align-items-center justify-content-center mb-0">
                        Event management and tools!
                    </h1>
                </div>
            </div>
        </div>
         <div class="text-center">
        <video autoplay="true" id="video-element"></video>
    </div>

    <div class="row align-items-start mt-3">
        <div id="img-element" class="col-md-8"></div>
        <div id="recognition-result" class="col-md-4">
    </div>
</div>
    <style>
        #img-element img:not(:empty) {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
        }

        .user-profile:not(:empty) {
            text-align: center;
        }

        .user-profile img {
            border-radius: 10px;
            margin-bottom: 10px;
            max-width: 100%;
            height: auto;
        }

        .user-profile p {
            margin: 4px 0;
        }

        .user-profile button {
            margin: 5px;
        }

    </style>

    <div class="text-center mt-3">
        <button class="btn btn-primary" id="capture-btn">take photo</button>
        <button class="btn btn-info" id="reload-btn">reload</button>
    </div> 
    <input type="hidden" id="event_id" value="{{ event.id }}">

        <script>

        const getCookie = (name) => {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const csrftoken = getCookie('csrftoken');

        const video = document.getElementById('video-element')
        const image = document.getElementById('img-element')
        const captureBtn = document.getElementById('capture-btn')
        const reloadBtn = document.getElementById('reload-btn')



        reloadBtn.addEventListener('click', () => {
            window.location.reload()
        })

        if (navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({video: true})
            .then((stream) => {
                video.srcObject = stream
                const {height, width} = stream.getTracks()[0].getSettings()

                captureBtn.addEventListener('click', e=> {
                    e.preventDefault()
                    captureBtn.classList.add('not-visible')
                    const track = stream.getVideoTracks()[0]
                    const imageCapture = new ImageCapture(track)

                    imageCapture.takePhoto().then(blob => {
                        console.log("took photo:", blob)
                        const img = new Image(width, height)
                        img.src = URL.createObjectURL(blob)
                        image.append(img)
                        image.classList.add('p-2', 'd-flex', 'justify-content-center', 'align-items-center', 'border', 'rounded', 'bg-light');
                        video.classList.add('not-visible')

                        const reader = new FileReader()
                        const event_id = document.getElementById("event_id").value;

                        reader.readAsDataURL(blob)
                        reader.onloadend = () => {
                            const base64data = reader.result
                            console.log(base64data)

                            const fd = new FormData()
                            fd.append('csrfmiddlewaretoken', csrftoken)
                            fd.append('photo', base64data)
                            fd.append('event_id', event_id);

                            $.ajax({
                                type: 'POST',
                                url: '/find_user_view/',
                                enctype: 'multipart/form-data',
                                data: fd,
                                processData: false,
                                contentType: false,
                                success: (resp) => {
                                            console.log(resp);
                                            const resultDiv = document.getElementById('recognition-result');
                                            resultDiv.innerHTML = '';
                                            
                                            if (resp.status === 'success' && resp.logged === 1 && resp.user) {
                                                const user = resp.user;

                                                resultDiv.classList.add('p-3', 'border', 'rounded', 'bg-white', 'shadow-sm');
                                                resultDiv.innerHTML = `
                                                    <div class="user-profile">
                                                        <img src="${user.photo_url}" alt="Poză ${user.name}" width="150">
                                                        <p><strong>Nume:</strong> ${user.name}</p>
                                                        <p><strong>Email:</strong> ${user.email}</p>
                                                        <p><strong>This user attendance is already confirmed:</strong></p>
                                                    </div>
                                                `;
                                            }

                                            else if (resp.status === 'success' && resp.user) {
                                                const user = resp.user;
                                                const log_id = resp.log_id;

                                                resultDiv.innerHTML = `
                                                    <div class="user-profile">
                                                        <img src="${user.photo_url}" alt="Poză ${user.name}" width="150">
                                                        <p><strong>Nume:</strong> ${user.name}</p>
                                                        <p><strong>Email:</strong> ${user.email}</p>
                                                        <button id="validate-btn" class="btn btn-success">Confirm</button>
                                                        <button id="reject-btn" class="btn btn-danger">Incorect guest</button>
                                                    </div>
                                                `;

                                                // Buton de validare
                                                document.getElementById('validate-btn').addEventListener('click', () => {
                                                    $.ajax({
                                                        type: 'POST',
                                                        url: '/validate_attendance/',
                                                        data: JSON.stringify({ user_id: user.id, event_id: event_id, log_id: log_id }),
                                                        contentType: 'application/json',
                                                        success: (resp) => {
                                                            addGuestToTable(resp.user);
                                                            document.getElementById('recognition-result').style.display = 'none';
                                                        },
                                                        error: (err) => {
                                                            console.log(err);
                                                            alert("Eroare la confirmarea prezenței.");
                                                        }
                                                    });
                                                });

                                                // Buton de respingere
                                                document.getElementById('reject-btn').addEventListener('click', () => {
                                                    resultDiv.innerHTML = '<p class="text-warning">Invitatul nu a fost recunoscut corect. Te rugăm să încerci din nou.</p>';
                                                });

                                            }  else if (resp.result === 'Not_found') {
                                                resultDiv.innerHTML = `
                                                    <div class="user-profile">
                                                        <p><strong>The person is not registered for this event:</strong></p>
                                                    </div>
                                                `;
                                            } else {
                                                resultDiv.innerHTML = '<p class="text-danger">Procesing error.</p>';
                                            }
                                },
                                error: (err) => {
                                    console.log(err)
                                }
                            })
                        }
                    }).catch(error => {
                        console.log('takePhoto() error: ', error);
                    });
                });
            })
            .catch(error => {
                console.log("Something went wrong!", error);
            });
        }

        

        function addGuestToTable(userData) {
            const tbody = document.getElementById('attendance-table-body');

            const newRow = document.createElement('tr');
            const currentTime = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            newRow.innerHTML = `
                <td class="ps-0 fw-medium"><span>#</span></td>
                <td class="text-center fw-medium">
                    <img src="${userData.photo_url}" class="rounded-circle" width="35" height="35">
                </td>
                <td><span>${userData.name}</span></td>
                <td class="text-center fw-medium">
                    <span class="badge bg-success-subtle text-success text-uppercase">Confirmed</span>
                </td>
                <td class="text-center fw-medium">${userData.arriving_time}</td>
                <td class="text-center fw-medium">${userData.gender}</td>
                <td class="text-center fw-medium">${userData.cuisine_preference}</td>
                <td class="text-center fw-medium">${userData.is_vegan ? 'vegan' : 'non-vegan'}</td>
                <td class="text-center fw-medium">${userData.allergens.length > 0 ? userData.allergens.join(', ') : 'None'}</td>
                <td class="text-center fw-medium">${userData.table_number}</td>
            `;


            tbody.appendChild(newRow);
            updateRowNumbers();
        }

        function updateRowNumbers() {
            const rows = document.querySelectorAll('#attendance-table-body tr');
            rows.forEach((tr, idx) => {
                const cell = tr.querySelector('td span');
                if (cell) {
                    cell.innerText = `${idx + 1}.`;
                }
            });
        }

        </script>


        <div class="col-lg-12">
                <div class="card">
                    <div class="card-body">
                        <div class="table-header d-flex justify-content-between">
                            <div class="table-header-title">
                                <h5 class="card-title">Guest list</h5>
                            </div>  
                            <div class="table-header-actions">
                                {% if guests_count == logs.count %}
                                <span class="badge bg-success-subtle text-success text-uppercase">All guests arrived</span>
                                {% else %}
                                <p class="text-dark">{{ logs.count }} / {{guests_count}} guests arrived</p>
                                {% endif %} 
                            </div>
                        </div>    
                        <div class="table-responsive">
                            <table class="table text-nowrap align-middle mb-0">
                            <thead>
                                <tr class="border-2 border-bottom border-primary justify-content-center border-0">
                                    <th scope="col" class="ps-0 text-center">Id</th>
                                    <th scope="col" class="text-center">Photo</th>
                                    <th scope="col" class="ps-0 text-center">Full name</th>
                                    <th scope="col" class="text-center">Status</th>
                                    <th scope="col" class="text-center">Arriving time</th>
                                    <th scope="col" class="text-center">Gender</th>
                                    <th scope="col" class="text-center">Cuisine preference</th>
                                    <th scope="col" class="text-center">Vegan</th>
                                    <th scope="col" class="text-center">Allergens</th>
                                    <th scope="col" class="text-center">Table no.</th>
                                </tr>
                            </thead>
                            <tbody class="table-group-divider" id="attendance-table-body">
                                    {% if logs %}
                                        {% for log in logs %}
                                            <tr>
                                                <td class="ps-0 fw-medium"><span>{{ forloop.counter }}.</span></td>
                                                <td class="text-center fw-medium">
                                                    <img src="{{ log.profile.photo.url }}" class="rounded-circle" width="35" height="35">
                                                </td>
                                                <td><span>{{ log.profile.first_name }} {{ log.profile.last_name }}</span></td>
                                                <td class="text-center fw-medium">
                                                    <span class="badge bg-success-subtle text-success text-uppercase">Confirmed</span>
                                                </td>
                                                <td class="text-center fw-medium">{{ log.created|date:"d, H:i" }}</td>
                                                <td class="text-center fw-medium">{{ log.profile.guest_profile.gender }}</td>
                                                <td class="text-center fw-medium">{{ log.profile.guest_profile.cuisine_preference }}</td>
                                                {% if log.profile.guest_profile.is_vegan %}
                                                <td class="text-center fw-medium">vegan</td>
                                                {% else %}
                                                <td class="text-center fw-medium">non-vegan</td>
                                                {% endif %}
                                                {% if log.profile.guest_profile.allergens.all %}
                                                <td class="text-center fw-medium">{{ log.profile.guest_profile.allergens.all|join:", " }}</td>
                                                {% else %}
                                                <td class="text-center fw-medium">None</td>
                                                {% endif %}
                                                <td class="text-center fw-medium">{{ log.table_number }}</td>
                                            </tr>
                                        {% endfor %}
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
        </div>
        <!-- <div class="col-lg-4 h-100">
            <div class="row gap gap-4">
                <div class="col-lg-12">
                    <div class="card card-hover h-100">
                            <div class="card-header">No. of guests arrived!</div>
                                <div class="card-body d-flex align-items-center p-4 fs-5 gap-4">
                                        <div class="d-flex align-items-center me-auto">
                                        <i class="ti ti-eye text-dark fs-5"></i>{{ event.guests.count }}
                                        </div>
                                        <div class="d-flex align-items-center me-auto">
                                            <i class="ti ti-message-2 text-dark fs-5"></i>/
                                        </div>
                                        <div class="d-flex align-items-center me-auto">
                                        <i class="ti ti-message-2 text-dark fs-5"></i> {{event.location.seats_numbers}}
                                        </div>
                                </div>
                    </div>
                </div>
                <div class="col-lg-12">
                    <div class="card card-hover h-100">
                        <div class="card-header">Time until the event starts!</div>
                            <div class="card-body d-flex align-items-center justify-content-center p-2 fs-5 gap-3">
                                <div class="d-flex align-items-center me-auto">
                                    <i class="ti ti-eye text-dark fs-5 ml-2"></i>{{ event.event_time }}
                                    </div>
                                    <div class="d-flex align-items-center me-auto">
                                        <i class="ti ti-message-2 text-dark fs-5"></i>/
                                    </div>
                                    <div class="d-flex align-items-center me-auto">
                                    <i class="ti ti-message-2 text-dark fs-5"></i> local time
                                    </div>
                            </div>
                    </div>
                </div>
            </div>
        </div> -->
        
    </div>
    </div>
    </div>
</div> 
{% endblock content %}

{% block javascript %}

{% endblock javascript %}
