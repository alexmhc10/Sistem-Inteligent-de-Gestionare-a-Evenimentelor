{% extends 'main.html' %}
{% block navbar %}
{% endblock %}


{% block content %}
<style>
    .glow-text {
        color: white;
        text-shadow: 
            0 0 5px #fff,
            0 0 10px #fff,
            0 0 20px #deb6b6,
            0 0 50px #b9e1db;
        font-weight: bold;
        text-align: center;
    }
    .not-visible {
        display: none;
    }
    .visible{
        display: block;
    }
</style>

<div class="page-wrapper" id="main-wrapper" data-layout="vertical" data-navbarbg="skin6" data-sidebartype="full"
data-sidebar-position="fixed" data-header-position="fixed">
    <!-- Sidebar Start -->
    {% include 'sidebar.html' %}
    <!--  Main wrapper -->
    <div class="body-wrapper">
    <!--  Header Start -->
    {% include 'header.html' %}

    <div class="container-fluid">
        <div class="row">

        <div class="col-lg-9">
            <div class="row d-flex flex-column flex-wrap">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-body">
                            <h1 class="card-title d-flex align-items-center gap-2">
                                {{ event.event_name }}! 
                            </h1>
                            <div class="d-flex align-items-center gap-4 mt-4">
                                <div class="d-flex align-items-center gap-2">
                                <i class="ti ti-eye text-dark fs-5"></i>{{ event.guests.count }} guests
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                <i class="ti ti-message-2 text-dark fs-5"></i> {{event.location.seats_numbers}} seats
                                </div>
                                <div class="d-flex align-items-center fs-2 ms-auto">
                                <i class="ti ti-point text-dark"></i>{{ event.event_date }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-body">
                            <h1 class="card-title text-center">Time left until event start!</h1>
                            {% include 'timer.html' %}
                        </div>
                    </div>
                </div>
            </div>    
        </div>
        
        <!-- <div class="col-lg-3">
            <div class="card">
                <img src="{{ MEDIA_URL }}{{ event.location.gallery }}" class="card-img" style="max-height: 300px; object-fit: cover;">
                <div class="card-img-overlay"></div>
            </div>
        </div> -->

        <div class="col-lg-3">
            <div class="card">
                <div class="card-body">
                    <h1 class="card-title">Send a notification</h1>
                    <form action="{% url 'send_notification' %}" method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input type="hidden" name="event_id" value="{{ event.id }}">
                        <label for="receiver">To:</label>
                        <select class="form-control mb-2" name="receiver" id="receiver">
                            <option value="organizer">The organiser</option>
                            <option value="everyone">Organiser and guests</option>
                        </select>
                        <textarea class="form-control mb-2" name="message" id="message" cols="30" rows="2"></textarea>
                        <button type="submit" name="submit" class="btn btn-primary">Send</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-12">
            <div class="card">
                <div class="card-body">
                    <h1 class="card-title d-flex align-items-center justify-content-center mb-0">
                        Event management and tools!
                    </h1>
                </div>
            </div>
        </div>
         <div class="text-center">
        <video autoplay="true" id="video-element"></video>
    </div>

    <div class="row align-items-start mt-3">
        <div id="img-element" class="col-md-8"></div>
        <div id="recognition-result" class="col-md-4">
    </div>
</div>
    <style>
        #img-element img:not(:empty) {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
        }

        .user-profile:not(:empty) {
            text-align: center;
        }

        .user-profile img {
            border-radius: 10px;
            margin-bottom: 10px;
            max-width: 100%;
            height: auto;
        }

        .user-profile p {
            margin: 4px 0;
        }

        .user-profile button {
            margin: 5px;
        }

    </style>

    <div class="text-center mt-3">
        <button class="btn btn-primary" id="capture-btn">take photo</button>
        <button class="btn btn-info" id="reload-btn">reload</button>
    </div> 
    <input type="hidden" id="event_id" value="{{ event.id }}">

        <script>

        const getCookie = (name) => {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const csrftoken = getCookie('csrftoken');

        const video = document.getElementById('video-element')
        const image = document.getElementById('img-element')
        const captureBtn = document.getElementById('capture-btn')
        const reloadBtn = document.getElementById('reload-btn')



        reloadBtn.addEventListener('click', () => {
            window.location.reload()
        })

        if (navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({video: true})
            .then((stream) => {
                video.srcObject = stream
                const {height, width} = stream.getTracks()[0].getSettings()

                captureBtn.addEventListener('click', e=> {
                    e.preventDefault()
                    captureBtn.classList.add('not-visible')
                    const track = stream.getVideoTracks()[0]
                    const imageCapture = new ImageCapture(track)

                    imageCapture.takePhoto().then(blob => {
                        console.log("took photo:", blob)
                        const img = new Image(width, height)
                        img.src = URL.createObjectURL(blob)
                        image.append(img)
                        image.classList.add('p-2', 'd-flex', 'justify-content-center', 'align-items-center', 'border', 'rounded', 'bg-light');
                        video.classList.add('not-visible')

                        const reader = new FileReader()
                        const event_id = document.getElementById("event_id").value;

                        reader.readAsDataURL(blob)
                        reader.onloadend = () => {
                            const base64data = reader.result
                            console.log(base64data)

                            const fd = new FormData()
                            fd.append('csrfmiddlewaretoken', csrftoken)
                            fd.append('photo', base64data)
                            fd.append('event_id', event_id);

                            $.ajax({
                                type: 'POST',
                                url: '/find_user_view/',
                                enctype: 'multipart/form-data',
                                data: fd,
                                processData: false,
                                contentType: false,
                                success: (resp) => {
                                            console.log(resp);
                                            const resultDiv = document.getElementById('recognition-result');
                                            resultDiv.innerHTML = '';
                                            
                                            if (resp.status === 'success' && resp.logged === 1 && resp.user) {
                                                const user = resp.user;

                                                resultDiv.classList.add('p-3', 'border', 'rounded', 'bg-white', 'shadow-sm');
                                                resultDiv.innerHTML = `
                                                    <div class="user-profile">
                                                        <img src="${user.photo_url}" alt="Poză ${user.name}" width="150">
                                                        <p><strong>Nume:</strong> ${user.name}</p>
                                                        <p><strong>Email:</strong> ${user.email}</p>
                                                        <p><strong>This user attendance is already confirmed:</strong></p>
                                                    </div>
                                                `;
                                            }

                                            else if (resp.status === 'success' && resp.user) {
                                                const user = resp.user;
                                                const log_id = resp.log_id;

                                                resultDiv.innerHTML = `
                                                    <div class="user-profile">
                                                        <img src="${user.photo_url}" alt="Poză ${user.name}" width="150">
                                                        <p><strong>Nume:</strong> ${user.name}</p>
                                                        <p><strong>Email:</strong> ${user.email}</p>
                                                        <button id="validate-btn" class="btn btn-success">Confirm</button>
                                                        <button id="reject-btn" class="btn btn-danger">Incorect guest</button>
                                                    </div>
                                                `;

                                                document.getElementById('validate-btn').addEventListener('click', () => {
                                                    $.ajax({
                                                        type: 'POST',
                                                        url: '/validate_attendance/',
                                                        data: JSON.stringify({ user_id: user.id, event_id: event_id, log_id: log_id }),
                                                        contentType: 'application/json',
                                                        success: (resp) => {
                                                            addGuestToTable(resp.user);
                                                            document.getElementById('recognition-result').style.display = 'none';
                                                        },
                                                        error: (err) => {
                                                            console.log(err);
                                                            alert("Eroare la confirmarea prezenței.");
                                                        }
                                                    });
                                                });

                                                document.getElementById('reject-btn').addEventListener('click', () => {
                                                    resultDiv.innerHTML = '<p class="text-warning">Invitatul nu a fost recunoscut corect. Te rugăm să încerci din nou.</p>';
                                                });

                                            }  else if (resp.result === 'Not_found') {
                                                resultDiv.innerHTML = `
                                                    <div class="user-profile">
                                                        <p><strong>The person is not registered for this event:</strong></p>
                                                    </div>
                                                `;
                                            } else {
                                                resultDiv.innerHTML = '<p class="text-danger">Procesing error.</p>';
                                            }
                                },
                                error: (err) => {
                                    console.log(err)
                                }
                            })
                        }
                    }).catch(error => {
                        console.log('takePhoto() error: ', error);
                    });
                });
            })
            .catch(error => {
                console.log("Something went wrong!", error);
            });
        }

        

        function addGuestToTable(userData) {
            const tbody = document.getElementById('attendance-table-body');

            const newRow = document.createElement('tr');
            const currentTime = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            newRow.innerHTML = `
                <td class="ps-0 fw-medium"><span>#</span></td>
                <td class="text-center fw-medium">
                    <img src="${userData.photo_url}" class="rounded-circle" width="35" height="35">
                </td>
                <td><span>${userData.name}</span></td>
                <td class="text-center fw-medium">
                    <span class="badge bg-success-subtle text-success text-uppercase">Confirmed</span>
                </td>
                <td class="text-center fw-medium">${userData.arriving_time}</td>
                <td class="text-center fw-medium">${userData.gender}</td>
                <td class="text-center fw-medium">${userData.cuisine_preference}</td>
                <td class="text-center fw-medium">${userData.is_vegan ? 'vegan' : 'non-vegan'}</td>
                <td class="text-center fw-medium">${userData.allergens.length > 0 ? userData.allergens.join(', ') : 'None'}</td>
                <td class="text-center fw-medium">${userData.table_number}</td>
            `;


            tbody.appendChild(newRow);
            updateRowNumbers();
        }

        function updateRowNumbers() {
            const rows = document.querySelectorAll('#attendance-table-body tr');
            rows.forEach((tr, idx) => {
                const cell = tr.querySelector('td span');
                if (cell) {
                    cell.innerText = `${idx + 1}.`;
                }
            });
        }

        </script>


        <div class="col-lg-12">
                <div class="card">
                    <div class="card-body">
                        <div class="table-header d-flex justify-content-between">
                            <div class="table-header-title">
                                <h5 class="card-title">Guest list</h5>
                            </div>  
                            <div class="table-header-actions">
                                {% if guests_count == logs.count %}
                                <span class="badge bg-success-subtle text-success text-uppercase">All guests arrived</span>
                                {% else %}
                                <p class="text-dark"><span id="guests-arrived">{{ logs.count }}</span> / {{event_guests_count}} guests arrived</p>
                                {% endif %} 
                            </div>
                            <div class="table-header-validation">
                                <button class="btn btn-primary" id="validation-btn">Manual validation</button>
                            </div>
                        </div>    
                        <div class="table-responsive">
                            <table class="table text-nowrap align-middle mb-0">
                            <thead>
                                <tr class="border-2 border-bottom border-primary justify-content-center border-0">
                                    <th scope="col" class="ps-0 text-center">Id</th>
                                    <th scope="col" class="text-center">Photo</th>
                                    <th scope="col" class="ps-0 text-center">Full name</th>
                                    <th scope="col" class="text-center">Status</th>
                                    <th scope="col" class="text-center">Arriving time</th>
                                    <th scope="col" class="text-center">Gender</th>
                                    <th scope="col" class="text-center">Cuisine preference</th>
                                    <th scope="col" class="text-center">Diet</th>
                                    <th scope="col" class="text-center">Allergens</th>
                                    <th scope="col" class="text-center">Table no.</th>
                                </tr>
                            </thead>
                            <tbody class="table-group-divider" id="attendance-table-body">
                                    {% if logs %}
                                        {% for log in logs %}
                                            <tr>
                                                <td class="ps-0 fw-medium"><span>{{ forloop.counter }}.</span></td>
                                                <td class="text-center fw-medium">
                                                    <img src="{{ log.profile.photo.url }}" class="rounded-circle" width="35" height="35">
                                                </td>
                                                <td><span>{{ log.profile.first_name }} {{ log.profile.last_name }}</span></td>
                                                <td class="text-center fw-medium">
                                                    <span class="badge bg-success-subtle text-success text-uppercase">Confirmed</span>
                                                </td>
                                                <td class="text-center fw-medium">{{ log.created|date:"d, H:i" }}</td>
                                                <td class="text-center fw-medium">{{ log.profile.guest_profile.gender }}</td>
                                                {% if log.profile.guest_profile.cuisine_preference %}
                                                <td class="text-center fw-medium">{{ log.profile.guest_profile.cuisine_preference }}</td>
                                                {% else %}
                                                <td class="text-center fw-medium">No preference</td>
                                                {% endif %}
                                                {% if log.profile.guest_profile.diet_preference %}
                                                <td class="text-center fw-medium">{{ log.profile.guest_profile.diet_preference }}</td>
                                                {% else %}
                                                <td class="text-center fw-medium">No preference</td>
                                                {% endif %}
                                                {% if log.profile.guest_profile.allergens.all %}
                                                <td class="text-center fw-medium">{{ log.profile.guest_profile.allergens.all|join:", " }}</td>
                                                {% else %}
                                                <td class="text-center fw-medium">None</td>
                                                {% endif %}
                                                <td class="text-center fw-medium">{{ log.profile.guest_profile.table_number|default:"-" }}</td>
                                            </tr>
                                        {% endfor %}
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
        </div>

        
        </div>
            <div class="row my-4">
                <div class="col-12">
                    <div class="card glass-effect">
                        <div class="card-body">
                            <h3 class="text-center mb-3">Room Layout - click on the table to see the guests</h3>
                            <div class="d-flex justify-content-start">
                                <input type="text" class="form-control mb-3" style="width: 200px;" id="search-input" placeholder="Search for a guest">
                            
                            </div>
                            <div id="layout-container" style="width:100%;height:600px;border:1px solid #ccc;background:#f8f9fa;border-radius:15px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div> 

<!-- Layout Visualization -->


<!-- Panel for table details -->
<style>
    #tablePanel {
        position: fixed;
        right: 20px;
        top: 100px;
        z-index: 4000;
        min-width: 260px;
        max-width: 500px;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 4px 16px #0003;
        display: none;
    }
    #tablePanelHeader {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px 4px 12px;
        border-bottom: 1px solid #eee;
    }
    #tablePanelHeader h6 {
        margin: 0;
        font-size: 1rem;
    }
    #tablePanelContent {
        padding: 10px 14px 14px 14px;
        max-height: 60vh;
        overflow-y: auto;
    }
</style>

<div id="tablePanel">
    <div id="tablePanelHeader">
        <h6 class="mb-0" id="tablePanelTitle">Table</h6>
        <button type="button" class="btn-close" id="tablePanelClose" aria-label="Close"></button>
    </div>
    <div id="tablePanelContent"></div>
</div>

<div id="tableTooltip" style="position:absolute;display:none;"></div>

<script src="https://cdn.jsdelivr.net/npm/konva@9.2.2/konva.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function(){
    const tooltip = document.getElementById('tableTooltip');
    const panel = document.getElementById('tablePanel');
    const panelTitle = document.getElementById('tablePanelTitle');
    const panelContent = document.getElementById('tablePanelContent');
    const panelCloseBtn = document.getElementById('tablePanelClose');

    panelCloseBtn.addEventListener('click', ()=>{ panel.style.display='none'; });

    const container = document.getElementById('layout-container');
    let width = container.offsetWidth;
    const height = 600;

    const stage = new Konva.Stage({ container:'layout-container', width:width, height:height });
    const gridLayer = new Konva.Layer({ listening:false });
    const layer = new Konva.Layer();
    stage.add(gridLayer);
    const gridSize = 50;
    function drawGrid(){
        const cols = Math.ceil(width/gridSize); const rows=Math.ceil(height/gridSize);
        for(let i=0;i<=cols;i++){ gridLayer.add(new Konva.Line({points:[i*gridSize,0,i*gridSize,height],stroke:'#e0e0e0',strokeWidth:1})); }
        for(let j=0;j<=rows;j++){ gridLayer.add(new Konva.Line({points:[0,j*gridSize,width,j*gridSize],stroke:'#e0e0e0',strokeWidth:1})); }
    }
    drawGrid();
    stage.add(layer);

    window.addEventListener('resize',()=>{
        width = container.offsetWidth; stage.width(width); gridLayer.destroyChildren(); drawGrid(); gridLayer.draw();
    });

    const tablesRaw = JSON.parse('{{ tables_json|escapejs }}');
    const specialRaw = JSON.parse('{{ special_json|escapejs }}');

    function drawTable(t){
        const x = Math.round(t.position_x/100*width);
        const y = Math.round(t.position_y/100*height);
        const group = new Konva.Group({x:x,y:y,rotation:t.rotation||0});
        const isRound = t.shape==='round';
        const radius = isRound ? (t.radius||45):null;
        const rectW = isRound?null:(t.width||90);
        const rectH = isRound?null:(t.height||90);
        let shape;
        if(isRound){
            shape=new Konva.Circle({radius:radius,fill:t.is_reserved?'#ffd700':'#28a745',stroke:t.is_reserved?'#b8860b':'#1e7e34',strokeWidth:3});
        }else{
            shape=new Konva.Rect({width:rectW,height:rectH,fill:t.is_reserved?'#ffd700':'#28a745',stroke:t.is_reserved?'#b8860b':'#1e7e34',strokeWidth:3,cornerRadius:10});
        }
        const labelW = isRound?radius*2:rectW;
        const labelX = isRound?-radius:0;
        const labelY = isRound?-12: (rectH/2-12);
        const text = new Konva.Text({
            text: t.table_number,
            fontSize: 20,
            fontStyle: 'bold',
            fill: '#fff',
            stroke: '#000',
            strokeWidth: 0.5,
            width: labelW,
            align: 'center',
            x: labelX,
            y: labelY
        });
        group.add(shape); group.add(text);
        group._tableId = t.id;
        group.on('click',()=>{
            fetch(`/api/table-details/${t.id}/?event_id={{ event.id }}`)
                .then(resp=>resp.json()).then(data=>{
                    let html = '';
                    if(data.guests && data.guests.length){
                        html += '<ul class="list-group list-group-flush">';
                        data.guests.forEach((g)=>{
                            let menuPart = '';
                            if(g.menu){
                                const order = ['appetizer','main','dessert','drink'];
                                order.forEach(cat=>{
                                    if(g.menu[cat] && g.menu[cat].length){
                                        const label = cat.charAt(0).toUpperCase()+cat.slice(1);
                                        menuPart += `<br/><small class='text-dark'><em>${label}:</em> ${g.menu[cat].join(', ')}</small>`;
                                    }
                                });
                            }

                            let dietary = '';
                            if(g.allergens && g.allergens.length){
                                dietary += `<br/><small class='text-danger'>Allergens: ${g.allergens.join(', ')}</small>`;
                            }
                            dietary += `<br/><small class='${g.diet_type ? 'text-success' : 'text-secondary'}'>${g.diet_type}</small>`;

                            const photoTag = g.photo ? `<img src="${g.photo}" class="rounded-circle me-2" width="35" height="35" alt="${g.name}">` : '';
                            html+=`<li class="list-group-item d-flex align-items-start">${photoTag}<div><strong>${g.name}</strong>${menuPart}${dietary}</div></li>`;
                        });
                        html+='</ul>';
                    }else{ html+='<p class="mb-0">No guests assigned</p>'; }
                    panelTitle.textContent = `Table ${t.table_number}`;
                    panelContent.innerHTML = html;
                    panel.style.display = 'block';
                });
        });
        layer.add(group);
    }

    tablesRaw.forEach(drawTable);

    const defs={
        entrance:{shape:'rect',color:'green',width:60,height:20,label:'Entrance'},
        dancefloor:{shape:'rect',color:'#b39ddb',width:200,height:120,opacity:0.3,label:'Dance Floor'},
        dj:{shape:'circle',color:'#ffb300',radius:25,label:'DJ/Band'},
        restrooms:{shape:'rect',color:'#90caf9',width:50,height:50,label:'Restrooms'},
        bar:{shape:'rect',color:'#ffe082',width:150,height:30,label:'Bar'},
        kitchen:{shape:'rect',color:'#616161',width:80,height:60,label:'Kitchen'},
        emergency:{shape:'rect',color:'red',width:60,height:20,label:'Emergency Exit'},
        photobooth:{shape:'circle',color:'#f06292',radius:30,label:'Photo Booth'},
        kids:{shape:'rect',color:'#fff59d',width:70,height:50,label:'Kids Area'}
    };
    specialRaw.forEach(function(el){
        const def = defs[el.type]||{shape:'rect',color:'#ccc',width:40,height:40};
        const grp = new Konva.Group({x:el.position_x/100*width,y:el.position_y/100*height,rotation:el.rotation||0});
        let shape;
        if(def.shape==='rect'){
            shape=new Konva.Rect({width:el.width||def.width,height:el.height||def.height,fill:def.color,cornerRadius:8});
            if(def.opacity) shape.opacity(def.opacity);
        }else{const r=el.radius||def.radius;shape=new Konva.Circle({radius:r,fill:def.color}); if(def.opacity) shape.opacity(def.opacity);} 

        const labelText = el.label || (def && def.label) || el.type;
        let labelX, labelY, labelWidth;
        if(def.shape === 'rect'){
            const w = el.width || def.width;
            const h = el.height || def.height;
            labelX = 0;
            labelY = h + 4;
            labelWidth = w;
        }else{
            const r = el.radius || def.radius;
            labelX = -r;
            labelY = r + 4;
            labelWidth = r*2;
        }
        const label = new Konva.Text({
            text: labelText,
            fontSize: 14,
            fill:'#000',
            width: labelWidth,
            align:'center',
            x: labelX,
            y: labelY
        });

        grp.add(shape);
        grp.add(label);
        layer.add(grp);
    });

    layer.draw();
   
    const searchInput = document.getElementById('search-input');
    searchInput.addEventListener('keyup', function(e){
        if(e.key !== 'Enter'){ return; }
        const query = this.value.trim();
        if(!query){ return; }

        fetch(`/api/guest-table/?event_id={{ event.id }}&q=${encodeURIComponent(query)}`)
        .then(resp=>resp.json())
        .then(data=>{
            if(!data.found){
                if(window.Swal){
                    Swal.fire('Not found','No guest matches this name','info');
                } else {
                    alert('Guest not found');
                }
                return;
            }

            const grp = layer.findOne(node => node._tableId === data.table_id);
            if(grp){ grp.fire('click'); }

            setTimeout(()=>{
                const rows = panelContent.querySelectorAll('li');
                rows.forEach(li => li.classList.remove('flash-row'));
                const target = Array.from(rows).find(li => li.textContent.toLowerCase().includes(data.guest_fullname.toLowerCase()));
                if(target){
                    target.classList.add('flash-row');
                    target.scrollIntoView({block:'center', behavior:'smooth'});
                }
            }, 400);
        })
        .catch(err=>console.error(err));
    });

    const validationBtn = document.getElementById('validation-btn');
    if(validationBtn){
        validationBtn.addEventListener('click', ()=>{
            if(!window.Swal){
                const name = prompt('Guest full name:');
                if(!name){ return; }
                manualValidate(name);
                return;
            }

            Swal.fire({
                title: 'Manual attendance',
                input: 'text',
                inputLabel: 'Enter guest full name',
                inputPlaceholder: 'e.g. John Doe',
                showCancelButton: true,
                confirmButtonText: 'Validate',
                preConfirm: (value)=>{
                    if(!value.trim()){
                        Swal.showValidationMessage('Please type a name');
                    }
                    return value.trim();
                }
            }).then(result=>{
                if(result.isConfirmed && result.value){
                    manualValidate(result.value);
                }
            });
        });
    }

    function manualValidate(name){
        fetch('/manual_validate_attendance/', {
            method: 'POST',
            headers: { 'Content-Type':'application/json' },
            body: JSON.stringify({ query: name, event_id: "{{ event.id }}" })
        })
        .then(resp=>resp.json())
        .then(data=>{
            if(!data.success){
                if(window.Swal){
                    Swal.fire('Error', data.error || 'Unable to validate', 'error');
                } else { alert(data.error||'Error'); }
                return;
            }
            addGuestToTable(data.user);
            if(window.Swal){
                Swal.fire('Success', 'Guest attendance confirmed!', 'success');
                const guestsArrived = document.getElementById('guests-arrived');
                guestsArrived.textContent = parseInt(guestsArrived.textContent) + 1;  
            }
 
        })
        .catch(err=>{
            console.error(err);
            if(window.Swal){ Swal.fire('Error','Server error','error'); } else { alert('Server error'); }
        });
    }

});
</script>

<style>
@keyframes flash {
    0%,100% { background:#fff; }
    50%     { background:#ffeaa7; }
}
.flash-row{
    animation: flash 1.5s ease-in-out 2;
}
</style>

{% endblock content %}

{% block javascript %}

{% endblock javascript %}
