{% extends 'main.html' %}
{% block navbar %}
{% endblock %}


{% block content %}

<div class="page-wrapper" id="main-wrapper" data-layout="vertical" data-navbarbg="skin6" data-sidebartype="full"
data-sidebar-position="fixed" data-header-position="fixed">
<aside class="left-sidebar">
  <div>
    <div class="brand-logo d-flex align-items-center justify-content-between">
      <a href="{% url 'personal_eveniment_home' %}" class="text-nowrap logo-img">
        <img src="../static/images/image.png" class="mt-3" style="max-width: 100%; max-height: 100%;">
      </a>
      <div class="close-btn d-xl-none d-block sidebartoggler cursor-pointer" id="sidebarCollapse">
        <i class="ti ti-x fs-8"></i>
      </div>
    </div>
    <nav class="sidebar-nav scroll-sidebar" data-simplebar="">
      <ul id="sidebarnav">
        <li class="nav-small-cap">
          <i class="ti ti-dots nav-small-cap-icon fs-6"></i>
          <span class="hide-menu">Home</span>
        </li>
        <li class="sidebar-item">
          <a class="sidebar-link active ps-4" href="{% url 'personal_eveniment_home' %}  " aria-expanded="false">
            <i class="bi bi-house-fill"></i>
            <span class="hide-menu">Home</span>
          </a>
        </li>
        <li class="nav-small-cap">
          <i class="ti ti-dots nav-small-cap-icon fs-6"></i>
          <span class="hide-menu">Account</span>
        </li>
        <li class="sidebar-item">
          <a class="sidebar-link ps-4" href="{% url 'personal_profile' %}" aria-expanded="false">
            <i class="bi bi-person-fill"></i>
          <span class="hide-menu">Profile</span>
        </a>
      </li>
      </ul>
    </nav>
  </div>
</aside>

<div class="body-wrapper">

  <header class="app-header">
    <nav class="navbar navbar-expand-lg navbar-light">
      <ul class="navbar-nav">
        <li class="nav-item d-block d-xl-none">
          <a class="nav-link sidebartoggler nav-icon-hover" id="headerCollapse" href="javascript:void(0)">
            <i class="bi bi-list"></i>          
          </a>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link nav-icon-hover" href="#" id="notificationDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-bell-fill"></i>              
            <div id="notification-badge" class="notification bg-primary rounded-circle d-none"></div>
          </a>
          <ul class="dropdown-menu p-2" aria-labelledby="notificationDropdown" id="notification-list">
            <div class="d-flex flex-row justify-content-between">
              <li class="dropdown-header">Notifications</li>
              <li class="dropdown-header"><button id="mark-as-read-button" class="btn p-0 m-0"><i class="bi bi-eyeglasses p-0 m-0"></i></button></li>
            </div>            
              
              <li><hr class="dropdown-divider"></li>
              <li class="text-center"><small>You got no notifications</small></li>
          </ul>
      </li>
      <script>
        document.addEventListener("DOMContentLoaded", function () {
        const notificationButton = document.getElementById("notificationDropdown");
        const markAsReadButton = document.getElementById("mark-as-read-button");
        const notificationList = document.getElementById("notification-list");
        const notificationBadge = document.getElementById("notification-badge");

        function fetchNotifications() {
            fetch("/get_notifications/")
                .then(response => response.json())
                .then(data => {
                    notificationList.innerHTML = '<div class="d-flex flex-row justify-content-between"><li class="dropdown-header">Notifications</li><li class="dropdown-header"><button id="mark-as-read-button" class="btn p-0 m-0"><i class="bi bi-eyeglasses p-0 m-0"></i></button></li></div><li><hr class="dropdown-divider"></li>';
                    if (data.notifications && data.notifications.length > 0) {
                        data.notifications.forEach(notification => {
                            const listItem = document.createElement("li");
                            const eventId = notification.event_id;
                              const eventUrl = `/personal_vizualizare_eveniment/${eventId}`;
                            listItem.innerHTML = `<a class="dropdown-item" href="${eventUrl}">${notification.message} <small class="text-muted">(${notification.timestamp})</small></a>`;
                            notificationList.appendChild(listItem);
                        });
                        notificationBadge.classList.remove("d-none");
                    } else {
                        notificationList.innerHTML += '<li class="text-center"><small>You got no notifications</small></li>';
                        notificationBadge.classList.add("d-none");
                    }
                    document.getElementById("mark-as-read-button").addEventListener("click", markNotificationsAsRead);
                })
                .catch(error => console.error("Error:", error));
        }
        

        function markNotificationsAsRead() {
          fetch("/mark_notifications_as_read/", {
              method: "POST",
              headers: {
                  "Content-Type": "application/json",
                  "X-CSRFToken": getCookie("csrftoken"),
              },
              body: JSON.stringify({}),
          })
          .then(response => response.json())
          .then(data => {
              if (data.status === "success") {
                  notificationBadge.classList.add("d-none");
              }
          })
          .catch(error => console.error("Error:", error));
        }
        markAsReadButton.addEventListener("click", markNotificationsAsRead);
       
        function getCookie(name) {
          let cookieValue = null;
          if (document.cookie && document.cookie !== '') {
              const cookies = document.cookie.split(';');
              for (let i = 0; i < cookies.length; i++) {
                  const cookie = cookies[i].trim();
                  if (cookie.substring(0, name.length + 1) === (name + '=')) {
                      cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                      break;
                  }
              }
          }
          return cookieValue;
      }
      notificationButton.addEventListener("click", fetchNotifications);
        
        setInterval(fetchNotifications, 10000);
 });
      </script>
      </ul>
      <div class="navbar-collapse justify-content-end px-0" id="navbarNav">
        <ul class="navbar-nav flex-row ms-auto align-items-center justify-content-end">
          <li class="nav-item dropdown">
            <a class="nav-link nav-icon-hover" href="javascript:void(0)" id="drop2" data-bs-toggle="dropdown"
              aria-expanded="false">
              <img src="{{ MEDIA_URL }}{{ request.user.location_set.all.0.gallery }}" alt="Ceva" width="35" height="35" class="rounded-circle">
            </a>
            <div class="dropdown-menu dropdown-menu-end dropdown-menu-animate-up" aria-labelledby="drop2">
              <div class="message-body">
                <a href="{% url 'personal_profile' %}" class="d-flex align-items-center gap-2 dropdown-item">
                  <i class="ti ti-user fs-6"></i>
                  <p class="mb-0 fs-3">My Profile</p>
                </a>
                <a href="{% url 'logout' %}" class="btn btn-outline-primary mx-3 mt-2 d-block">Logout</a>
              </div>
            </div>
          </li>
        </ul>
      </div>
    </nav>
  </header>
  <!--  Header End -->
   
  <div class="container-fluid">

    <!-- <div class="col-lg-12 mb-4">
      <h2 class="mb-4">Filter Events</h2>
      <form id="filtersForm" class="row gy-3 gx-3 align-items-center">
          <div class="col-md-4">
              <label for="search" class="form-label">Search</label>
              <input type="text" class="form-control" id="search" placeholder="Search events...">
          </div>
          <div class="col-md-4">
              <label for="eventType" class="form-label">Event Type</label>
              <select class="form-select" id="eventType">
                  <option value="">All Events</option>
                  <option value="future">Future Events</option>
                  <option value="past">Past Events</option>
              </select>
          </div>
          <div class="col-md-4">
              <label for="filterDate" class="form-label">Filter by Date</label>
              <input type="date" class="form-control" id="filterDate">
          </div>
          <div class="col-12 text-end">
              <button type="button" id="applyFilters" class="btn btn-primary">Apply Filters</button>
              <button type="reset" id="resetFilters" class="btn btn-secondary">Reset</button>
          </div>
      </form>
    </div> -->
    
    <div class="col-lg-12">
      <div class="card card-hover">
        <div class="card-body">
          <h1 class="card-title d-flex align-items-center">
            Welcome this is your homepage, down below you can acces all the events organised at your location!
          </h1>
        </div>
      </div>
    </div>
    <hr>
    <div class="row">
        <div class="col-lg-5 col-sm-6">
            <div class="card card-hover">
                <div class="card-body">
                    <h1 class="card-title d-flex align-items-center gap-2">
                       Next upcoming event!
                    </h1>
                    <p>Check out event details by accesing the event</p>
                </div>
          </div>
        </div>
        <div class="col-lg-4 col-sm-6">
          <div class="card card-hover">
            <div class="card-body">
              <h1 class="card-title d-flex align-items-center gap-2">
                Time left until event start!
             </h1>
                    <div class="event">
                        <p id="countdown-{{ next_event.id }}">Nimic</p>
                    </div>
                  
                  <script>
                      document.addEventListener("DOMContentLoaded", function () {
                      try {
                          var eventDataArray = JSON.parse('{{ next_event_data|safe }}');
                          
                          if (!eventDataArray || eventDataArray.length === 0) {
                              console.warn("No upcoming event found!");
                              return;
                          }

                          var eventData = eventDataArray[0];
                          
                          console.log("Event Data:", eventData);

                          var eventDate = new Date(eventData.event_date).getTime();
                          var countdownElement = document.getElementById("countdown-" + eventData.id);

                          if (!countdownElement) {
                              console.warn("Countdown element not found!");
                              return;
                          }

                          function updateCountdown() {
                              var now = new Date().getTime();
                              var timeLeft = eventDate - now;

                              var days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                              var hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                              var minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                              var seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

                              countdownElement.innerHTML = timeLeft > 0
                                  ? `${days} days, ${hours} hours, ${minutes} minutes, ${seconds} seconds`
                                  : "The event is live!";
                          }

                          updateCountdown();
                          setInterval(updateCountdown, 1000);
                      } catch (error) {
                          console.error("Error parsing event data:", error);
                      }
                  });


                  </script>
                    </div>
                  </div>
        </div>
       </div>             

               
           
      <div id="futureEventsSection">
          <div class="row">
              <div class="col-lg-4">
                <div class="card overflow-hidden hover-img card-hover">
                  <div class="position-relative">
                    <a href="{% url 'personal_vizualizare_eveniment' next_event.id %}">
                      <img src="{{ MEDIA_URL }}{{next_event.location.gallery}}" class="card-img-top" style="max-height: 250px; object-fit: cover;" alt="matdash-img">
                    </a>
                    <span class="badge text-bg-light text-dark fs-2 lh-sm mb-9 me-9 py-1 px-2 fw-semibold position-absolute bottom-0 end-0">{{ next_event.event_time }}</span>
                    <img src="{{ MEDIA_URL }}{{ next_event.organized_by.profile_set.all.0.photo }}" alt="matdash-img" class="img-fluid rounded-circle position-absolute bottom-0 start-0 mb-n9 ms-9" style="width: 40px; max-height: 40px; object-fit: cover;" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Georgeanna Ramero">
                  </div>
                  <div class="card-body p-4">
                    <span class="badge text-bg-light fs-2 py-1 px-2 lh-sm  mt-3">{{ next_event.organised_by }}</span>
                    <a class="d-block my-4 fs-5 text-dark fw-semibold link-primary" href="">{{ next_event.event_name }}</a>
                    <div class="d-flex align-items-center gap-4">
                      <div class="d-flex align-items-center gap-2">
                        <i class="ti ti-eye text-dark fs-5"></i>{{ next_event.guests.count }} guests
                      </div>
                      <div class="d-flex align-items-center gap-2">
                        <i class="ti ti-message-2 text-dark fs-5"></i> {{ next_event.location.seats_numbers }} seats
                      </div>
                      <div class="d-flex align-items-center fs-2 ms-auto">
                        <i class="ti ti-point text-dark"></i>{{ next_event.event_date }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
          </div>
      </div>
      

        <div class="col-lg-12">
          <div class="card card-hover">
              <div class="card-body">
                  <h1 class="card-title d-flex align-items-center gap-2">
                      Future events planned!
                  </h1>
              </div>
          </div>
        </div>
        <div class="row">
          {% for event in remaining_events %}         
           <div class="col-lg-4">
            <div class="card overflow-hidden hover-img card-hover">
              <div class="position-relative">
                <a href="{% url 'personal_vizualizare_eveniment' event.id %}">
                  <img src="{{ MEDIA_URL }}{{event.location.gallery}}" class="card-img-top" style="max-height: 250px; object-fit: cover;" alt="matdash-img">
                </a>
                <span class="badge text-bg-light text-dark fs-2 lh-sm mb-9 me-9 py-1 px-2 fw-semibold position-absolute bottom-0 end-0">{{ next_event.event_time }}</span>
                <img src="{{ MEDIA_URL }}{{ event.organized_by.profile_set.all.0.photo }}" alt="matdash-img" class="img-fluid rounded-circle position-absolute bottom-0 start-0 mb-n9 ms-9" style="width: 40px; max-height: 40px; object-fit: cover;" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Georgeanna Ramero">
              </div>
              <div class="card-body p-4">
                <span class="badge text-bg-light fs-2 py-1 px-2 lh-sm  mt-3">{{ event.organised_by }}</span>
                <a class="d-block my-4 fs-5 text-dark fw-semibold link-primary" href="">{{ event.event_name }}</a>
                <div class="d-flex align-items-center gap-4">
                  <div class="d-flex align-items-center gap-2">
                    <i class="ti ti-eye text-dark fs-5"></i>{{ event.guests.count }} guests
                  </div>
                  <div class="d-flex align-items-center gap-2">
                    <i class="ti ti-message-2 text-dark fs-5"></i> {{ event.location.seats_numbers }} seats
                  </div>
                  <div class="d-flex align-items-center fs-2 ms-auto">
                    <i class="ti ti-point text-dark"></i>{{ event.event_date }}
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
      </div>
  </div>
</div>
</div>
{% endblock %}