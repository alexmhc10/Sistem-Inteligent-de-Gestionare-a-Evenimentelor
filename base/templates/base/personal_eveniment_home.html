{% extends 'main.html' %}
{% block navbar %}
{% endblock %}


{% block content %}

<div class="page-wrapper" id="main-wrapper" data-layout="vertical" data-navbarbg="skin6" data-sidebartype="full"
data-sidebar-position="fixed" data-header-position="fixed">
<aside class="left-sidebar">
  <div>
    <div class="brand-logo d-flex align-items-center justify-content-between">
      <a href="{% url 'personal_eveniment_home' %}" class="text-nowrap logo-img">
        <img src="../static/images/image.png" class="mt-3" style="max-width: 100%; max-height: 100%;">
      </a>
      <div class="close-btn d-xl-none d-block sidebartoggler cursor-pointer" id="sidebarCollapse">
        <i class="ti ti-x fs-8"></i>
      </div>
    </div>
    <nav class="sidebar-nav scroll-sidebar" data-simplebar="">
      <ul id="sidebarnav">
        <li class="nav-small-cap">
          <i class="ti ti-dots nav-small-cap-icon fs-6"></i>
          <span class="hide-menu">Home</span>
        </li>
        <li class="sidebar-item">
          <a class="sidebar-link active ps-4" href="{% url 'personal_eveniment_home' %}  " aria-expanded="false">
            <i class="bi bi-house-fill"></i>
            <span class="hide-menu">Home</span>
          </a>
        </li>
        <li class="nav-small-cap">
          <i class="ti ti-dots nav-small-cap-icon fs-6"></i>
          <span class="hide-menu">Account</span>
        </li>
        <li class="sidebar-item">
          <a class="sidebar-link ps-4" href="{% url 'personal_profile' %}" aria-expanded="false">
            <i class="bi bi-person-fill"></i>
          <span class="hide-menu">Profile</span>
        </a>
      </li>
      </ul>
    </nav>
  </div>
</aside>

<div class="body-wrapper">

  <header class="app-header">
    <nav class="navbar navbar-expand-lg navbar-light">
      <ul class="navbar-nav">
        <li class="nav-item d-block d-xl-none">
          <a class="nav-link sidebartoggler nav-icon-hover" id="headerCollapse" href="javascript:void(0)">
            <i class="bi bi-list"></i>          
          </a>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link nav-icon-hover" href="#" id="notificationDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-bell-fill"></i>              
            <div id="notification-badge" class="notification bg-primary rounded-circle d-none"></div>
          </a>
          <ul class="dropdown-menu p-2" aria-labelledby="notificationDropdown" id="notification-list">
            <div class="d-flex flex-row justify-content-between">
              <li class="dropdown-header">Notifications</li>
              <li class="dropdown-header"><button id="mark-as-read-button" class="btn p-0 m-0"><i class="bi bi-eyeglasses p-0 m-0"></i></button></li>
            </div>            
              
              <li><hr class="dropdown-divider"></li>
              <li class="text-center"><small>You got no notifications</small></li>
          </ul>
      </li>
      <script>
        document.addEventListener("DOMContentLoaded", function () {
        const notificationButton = document.getElementById("notificationDropdown");
        const markAsReadButton = document.getElementById("mark-as-read-button");
        const notificationList = document.getElementById("notification-list");
        const notificationBadge = document.getElementById("notification-badge");

        function fetchNotifications() {
            fetch("/get_notifications/")
                .then(response => response.json())
                .then(data => {
                    notificationList.innerHTML = '<div class="d-flex flex-row justify-content-between"><li class="dropdown-header">Notifications</li><li class="dropdown-header"><button id="mark-as-read-button" class="btn p-0 m-0"><i class="bi bi-eyeglasses p-0 m-0"></i></button></li></div><li><hr class="dropdown-divider"></li>';
                    if (data.notifications && data.notifications.length > 0) {
                        data.notifications.forEach(notification => {
                            const listItem = document.createElement("li");
                            const eventId = notification.event_id;
                              const eventUrl = `/personal_vizualizare_eveniment/${eventId}`;
                            listItem.innerHTML = `<a class="dropdown-item" href="${eventUrl}">${notification.message} <small class="text-muted">(${notification.timestamp})</small></a>`;
                            notificationList.appendChild(listItem);
                        });
                        notificationBadge.classList.remove("d-none");
                    } else {
                        notificationList.innerHTML += '<li class="text-center"><small>You got no notifications</small></li>';
                        notificationBadge.classList.add("d-none");
                    }
                    document.getElementById("mark-as-read-button").addEventListener("click", markNotificationsAsRead);
                })
                .catch(error => console.error("Error:", error));
        }
        

        function markNotificationsAsRead() {
          fetch("/mark_notifications_as_read/", {
              method: "POST",
              headers: {
                  "Content-Type": "application/json",
                  "X-CSRFToken": getCookie("csrftoken"),
              },
              body: JSON.stringify({}),
          })
          .then(response => response.json())
          .then(data => {
              if (data.status === "success") {
                  notificationBadge.classList.add("d-none");
              }
          })
          .catch(error => console.error("Error:", error));
        }
        markAsReadButton.addEventListener("click", markNotificationsAsRead);
       
        function getCookie(name) {
          let cookieValue = null;
          if (document.cookie && document.cookie !== '') {
              const cookies = document.cookie.split(';');
              for (let i = 0; i < cookies.length; i++) {
                  const cookie = cookies[i].trim();
                  if (cookie.substring(0, name.length + 1) === (name + '=')) {
                      cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                      break;
                  }
              }
          }
          return cookieValue;
      }
      notificationButton.addEventListener("click", fetchNotifications);
        
        setInterval(fetchNotifications, 10000);
 });
      </script>
      </ul>
      <div class="navbar-collapse justify-content-end px-0" id="navbarNav">
        <ul class="navbar-nav flex-row ms-auto align-items-center justify-content-end">
          <li class="nav-item dropdown">
            <a class="nav-link nav-icon-hover" href="javascript:void(0)" id="drop2" data-bs-toggle="dropdown"
              aria-expanded="false">
              <img src="{{ MEDIA_URL }}{{ request.user.location_set.all.0.gallery }}" alt="Ceva" width="35" height="35" class="rounded-circle">
            </a>
            <div class="dropdown-menu dropdown-menu-end dropdown-menu-animate-up" aria-labelledby="drop2">
              <div class="message-body">
                <a href="{% url 'personal_profile' %}" class="d-flex align-items-center gap-2 dropdown-item">
                  <i class="ti ti-user fs-6"></i>
                  <p class="mb-0 fs-3">My Profile</p>
                </a>
                <a href="{% url 'logout' %}" class="btn btn-outline-primary mx-3 mt-2 d-block">Logout</a>
              </div>
            </div>
          </li>
        </ul>
      </div>
    </nav>
  </header>
  <!--  Header End -->
   
  <div class="container-fluid">

    <!-- <div class="col-lg-12 mb-4">
      <h2 class="mb-4">Filter Events</h2>
      <form id="filtersForm" class="row gy-3 gx-3 align-items-center">
          <div class="col-md-4">
              <label for="search" class="form-label">Search</label>
              <input type="text" class="form-control" id="search" placeholder="Search events...">
          </div>
          <div class="col-md-4">
              <label for="eventType" class="form-label">Event Type</label>
              <select class="form-select" id="eventType">
                  <option value="">All Events</option>
                  <option value="future">Future Events</option>
                  <option value="past">Past Events</option>
              </select>
          </div>
          <div class="col-md-4">
              <label for="filterDate" class="form-label">Filter by Date</label>
              <input type="date" class="form-control" id="filterDate">
          </div>
          <div class="col-12 text-end">
              <button type="button" id="applyFilters" class="btn btn-primary">Apply Filters</button>
              <button type="reset" id="resetFilters" class="btn btn-secondary">Reset</button>
          </div>
      </form>
    </div> -->
    
    <div class="col-lg-12">
      <div class="card card-hover">
        <div class="card-body">
          <h1 class="card-title d-flex align-items-center">
            Welcome this is your homepage, down below you can acces all the events organised at your location!
          </h1>
        </div>
      </div>
    </div>
    <hr>
    <div class="row">
        <div class="col-lg-5">
            <div class="card card-hover">
                <div class="card-body">
                    <h1 class="card-title d-flex align-items-center gap-2">
                       Next upcoming event!
                    </h1>
                    <p>Check out event details by accesing the event</p>
                </div>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="card card-hover">
            <div class="card-body">
              <h1 class="card-title d-flex align-items-center gap-2">
                Time left until event start!
             </h1>
                    {% for event in event_data %}
                    <div class="event">
                        <p id="countdown-{{ event.id }}"></p>
                    </div>
                    {% endfor %}
              <script>
                        var events = {{ event_data|safe }};
                        
                        events.forEach(function(event) {
                            var eventDate = new Date(event.event_date).getTime();
                            var countdownElement = document.getElementById("countdown-" + event.id);
                            
                            function updateCountdown() {
                                var now = new Date().getTime();
                                var timeLeft = eventDate - now;
                
                                var days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                                var hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                                var minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                                var seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                
                                if (timeLeft > 0) {
                                    countdownElement.innerHTML = `${days} days, ${hours} hours, ${minutes} minutes, ${seconds} seconds`;
                                } else {
                                    countdownElement.innerHTML = "The event its live!";
                                }
                            }
                
                            updateCountdown(); 
                            setInterval(updateCountdown, 1000);
                        });
                    </script>
                    </div>
                  </div>
        </div>
       </div>             

               
           
      <div id="futureEventsSection">
        <div id="futureEventsContainer">
          <div class="row">
            {% for event in events %}
              <div class="col-lg-4">
                <div class="card overflow-hidden hover-img card-hover">
                  <div class="position-relative">
                    <a href="{% url 'personal_vizualizare_eveniment' event.id %}">
                      <img src="{{ MEDIA_URL }}{{event.location.gallery}}" class="card-img-top" style="max-height: 250px; object-fit: cover;" alt="matdash-img">
                    </a>
                    <span class="badge text-bg-light text-dark fs-2 lh-sm mb-9 me-9 py-1 px-2 fw-semibold position-absolute bottom-0 end-0">{{ event.event_time }}</span>
                    <img src="{{ MEDIA_URL }}{{ event.organized_by.profile_set.all.0.photo }}" alt="matdash-img" class="img-fluid rounded-circle position-absolute bottom-0 start-0 mb-n9 ms-9" style="width: 40px; max-height: 40px; object-fit: cover;" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Georgeanna Ramero">
                  </div>
                  <div class="card-body p-4">
                    <span class="badge text-bg-light fs-2 py-1 px-2 lh-sm  mt-3">{{ event.organised_by }}</span>
                    <a class="d-block my-4 fs-5 text-dark fw-semibold link-primary" href="">{{ event.event_name }}</a>
                    <div class="d-flex align-items-center gap-4">
                      <div class="d-flex align-items-center gap-2">
                        <i class="ti ti-eye text-dark fs-5"></i>{{ event.guests.count }} guests
                      </div>
                      <div class="d-flex align-items-center gap-2">
                        <i class="ti ti-message-2 text-dark fs-5"></i> {{event.location.seats_numbers}} seats
                      </div>
                      <div class="d-flex align-items-center fs-2 ms-auto">
                        <i class="ti ti-point text-dark"></i>{{ event.event_date }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
      

      <div id="pastEventsSection">
        <div class="col-lg-12">
          <div class="card card-hover">
              <div class="card-body">
                  <h1 class="card-title d-flex align-items-center gap-2">
                      Future events planned!
                    </h1>
              </div>
          </div>
        </div>
        <div id="pastEventsContainer">
        {% for event in past_events %}
          
        {% endfor %}
        </div>
      </div>

    
    <!--<div class="col-lg-8">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">View by page title and screen class</h5>
          <div class="table-responsive">
            <table class="table text-nowrap align-middle mb-0">
              <thead>
                <tr class="border-2 border-bottom border-primary border-0"> 
                  <th scope="col" class="ps-0">Page Title</th>
                  <th scope="col" >Link</th>
                  <th scope="col" class="text-center">Pageviews</th>
                  <th scope="col" class="text-center">Page Value</th>
                </tr>
              </thead>
              <tbody class="table-group-divider">
                <tr>
                  <th scope="row" class="ps-0 fw-medium">
                    <span class="table-link1 text-truncate d-block">Welcome to our
                      website</span>
                  </th>
                  <td>
                    <a href="javascript:void(0)" class="link-primary text-dark fw-medium d-block">/index.html</a>
                  </td>
                  <td class="text-center fw-medium">18,456</td>
                  <td class="text-center fw-medium">$2.40</td>
                </tr>
                <tr>
                  <th scope="row" class="ps-0 fw-medium">
                    <span class="table-link1 text-truncate d-block">Modern Admin
                      Dashboard Template</span>
                  </th>
                  <td>
                    <a href="javascript:void(0)" class="link-primary text-dark fw-medium d-block">/dashboard</a>
                  </td>
                  <td class="text-center fw-medium">17,452</td>
                  <td class="text-center fw-medium">$0.97</td>
                </tr>
                <tr>
                  <th scope="row" class="ps-0 fw-medium">
                    <span class="table-link1 text-truncate d-block">Explore our
                      product catalog</span>
                  </th>
                  <td>
                    <a href="javascript:void(0)" class="link-primary text-dark fw-medium d-block">/product-checkout</a>
                  </td>
                  <td class="text-center fw-medium">12,180</td>
                  <td class="text-center fw-medium">$7,50</td>
                </tr>
                <tr>
                  <th scope="row" class="ps-0 fw-medium">
                    <span class="table-link1 text-truncate d-block">Comprehensive
                      User Guide</span>
                  </th>
                  <td>
                    <a href="javascript:void(0)" class="link-primary text-dark fw-medium d-block">/docs</a>
                  </td>
                  <td class="text-center fw-medium">800</td>
                  <td class="text-center fw-medium">$5,50</td>
                </tr>
                <tr>
                  <th scope="row" class="ps-0 fw-medium border-0">
                    <span class="table-link1 text-truncate d-block">Check out our
                      services</span>
                  </th>
                  <td class="border-0">
                    <a href="javascript:void(0)" class="link-primary text-dark fw-medium d-block">/services</a>
                  </td>
                  <td class="text-center fw-medium border-0">1300</td>
                  <td class="text-center fw-medium border-0">$2,15</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title d-flex align-items-center gap-2 mb-5 pb-3">Sessions by
            device<span><iconify-icon icon="solar:question-circle-bold" class="fs-7 d-flex text-muted" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-custom-class="tooltip-success" data-bs-title="Locations"></iconify-icon></span>
          </h5>
          <div class="row">
            <div class="col-4">
              <iconify-icon icon="solar:laptop-minimalistic-line-duotone" class="fs-7 d-flex text-primary"></iconify-icon>
              <span class="fs-11 mt-2 d-block text-nowrap">Computers</span>
              <h4 class="mb-0 mt-1">87%</h4>
            </div>
            <div class="col-4">
              <iconify-icon icon="solar:smartphone-line-duotone" class="fs-7 d-flex text-secondary"></iconify-icon>
              <span class="fs-11 mt-2 d-block text-nowrap">Smartphone</span>
              <h4 class="mb-0 mt-1">9.2%</h4>
            </div>
            <div class="col-4">
              <iconify-icon icon="solar:tablet-line-duotone" class="fs-7 d-flex text-success"></iconify-icon>
              <span class="fs-11 mt-2 d-block text-nowrap">Tablets</span>
              <h4 class="mb-0 mt-1">3.1%</h4>
            </div>
          </div>

          <div class="vstack gap-4 mt-7 pt-2">
            <div>
              <div class="hstack justify-content-between">
                <span class="fs-3 fw-medium">Computers</span>
                <h6 class="fs-3 fw-medium text-dark lh-base mb-0">87%</h6>
              </div>
              <div class="progress mt-6" role="progressbar" aria-label="Warning example" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100">
                <div class="progress-bar bg-primary" style="width: 100%"></div>
              </div>
            </div>

            <div>
              <div class="hstack justify-content-between">
                <span class="fs-3 fw-medium">Smartphones</span>
                <h6 class="fs-3 fw-medium text-dark lh-base mb-0">9.2%</h6>
              </div>
              <div class="progress mt-6" role="progressbar" aria-label="Warning example" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100">
                <div class="progress-bar bg-secondary" style="width: 50%"></div>
              </div>
            </div>

            <div>
              <div class="hstack justify-content-between">
                <span class="fs-3 fw-medium">Tablets</span>
                <h6 class="fs-3 fw-medium text-dark lh-base mb-0">3.1%</h6>
              </div>
              <div class="progress mt-6" role="progressbar" aria-label="Warning example" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100">
                <div class="progress-bar bg-success" style="width: 35%"></div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>-->
    
  </div>
</div>
</div>
{% endblock %}