{% extends 'main.html' %}
{% block navbar %}
{% endblock %}

{% block content %}
<style>
    #container {
        border: 1px solid #ccc;
        width: 800px;
        height: 600px;
        margin: 20px auto;
    }
</style>
<div class="page-wrapper" id="main-wrapper" data-layout="vertical" data-navbarbg="skin6" data-sidebartype="full"
data-sidebar-position="fixed" data-header-position="fixed">
<!-- Sidebar Start -->
<aside class="left-sidebar">
  <!-- Sidebar scroll-->
  <div>
    <div class="brand-logo d-flex align-items-center justify-content-between">
      <a href="{% url 'personal_eveniment_home' %}" class="text-nowrap logo-img">
        <img src="../static/images/image.png" class="mt-3" style="max-width: 100%; max-height: 100%;">
      </a>
      <div class="close-btn d-xl-none d-block sidebartoggler cursor-pointer" id="sidebarCollapse">
        <i class="ti ti-x fs-8"></i>
      </div>
    </div>
    <!-- Sidebar navigation-->
    <nav class="sidebar-nav scroll-sidebar" data-simplebar="">
      <ul id="sidebarnav">
        <li class="nav-small-cap">
          <i class="ti ti-dots nav-small-cap-icon fs-6"></i>
          <span class="hide-menu">Home</span>
        </li>
        <li class="sidebar-item">
          <a class="sidebar-link" href="{% url 'personal_eveniment_home' %}  " aria-expanded="false">
            <span>
              <iconify-icon icon="solar:home-smile-bold-duotone" class="fs-6"></iconify-icon>
            </span>
            <span class="hide-menu">Home</span>
          </a>
        </li>
        <li class="nav-small-cap">
          <i class="ti ti-dots nav-small-cap-icon fs-6"></i>
          <span class="hide-menu">Managing tools</span>
        </li>
        <li class="sidebar-item">
          <a class="sidebar-link active" href="{% url 'personal_aranjament_invitati' %}" aria-expanded="false">
            <span>
              <iconify-icon icon="solar:layers-minimalistic-bold-duotone" class="fs-6"></iconify-icon>
            </span>
            <span class="hide-menu">Layout</span>
          </a>
        </li>
      </ul>
    </nav>
    <!-- End Sidebar navigation -->
  </div>
  <!-- End Sidebar scroll-->
</aside>
<!--  Sidebar End -->
<!--  Main wrapper -->
<div class="body-wrapper">
  <!--  Header Start -->
  <header class="app-header">
    <nav class="navbar navbar-expand-lg navbar-light">
      <ul class="navbar-nav">
        <li class="nav-item d-block d-xl-none">
          <a class="nav-link sidebartoggler nav-icon-hover" id="headerCollapse" href="javascript:void(0)">
            <i class="ti ti-menu-2"></i>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link nav-icon-hover" href="javascript:void(0)">
            <i class="ti ti-bell-ringing"></i>
            <div class="notification bg-primary rounded-circle"></div>
          </a>
        </li>
      </ul>
      <div class="navbar-collapse justify-content-end px-0" id="navbarNav">
        <ul class="navbar-nav flex-row ms-auto align-items-center justify-content-end">
          <li class="nav-item dropdown">
            <a class="nav-link nav-icon-hover" href="javascript:void(0)" id="drop2" data-bs-toggle="dropdown"
              aria-expanded="false">
              <img src="../assets/images/profile/user-1.jpg" alt="" width="35" height="35" class="rounded-circle">
            </a>
            <div class="dropdown-menu dropdown-menu-end dropdown-menu-animate-up" aria-labelledby="drop2">
              <div class="message-body">
                <a href="javascript:void(0)" class="d-flex align-items-center gap-2 dropdown-item">
                  <i class="ti ti-user fs-6"></i>
                  <p class="mb-0 fs-3">My Profile</p>
                </a>
                <a href="javascript:void(0)" class="d-flex align-items-center gap-2 dropdown-item">
                  <i class="ti ti-mail fs-6"></i>
                  <p class="mb-0 fs-3">My Account</p>
                </a>
                <a href="javascript:void(0)" class="d-flex align-items-center gap-2 dropdown-item">
                  <i class="ti ti-list-check fs-6"></i>
                  <p class="mb-0 fs-3">My Task</p>
                </a>
                <a href="./authentication-login.html" class="btn btn-outline-primary mx-3 mt-2 d-block">Logout</a>
              </div>
            </div>
          </li>
        </ul>
      </div>
    </nav>
  </header>
  <!--  Header End -->
  <div class="container-fluid">
    <div class="row">

      <div class="col-lg-12">
            <div class="card">
                <div class="card-body align-items-center">
                    <h1 class="card-title d-flex align-items-center gap-2">
                        Your event place seating layout
                    </h1>
                    <p>
                        Here you can customize the layout of your hall. You can move around the tables, add and remove them. The organizer will be able to see the layout so he can plan the event accordingly to his needs. 
                    </p>
                </div>
            </div>
      </div>

      {% for event in future_events %}
        <div class="col-lg-4">
          <div class="card overflow-hidden hover-img">
            <div class="position-relative">
              <a href="{% url 'personal_vizualizare_eveniment' event.id %}">
                <img src="{{ MEDIA_URL }}{{event.location.gallery}}" class="card-img-top" alt="matdash-img">
              </a>
              <span class="badge text-bg-light text-dark fs-2 lh-sm mb-9 me-9 py-1 px-2 fw-semibold position-absolute bottom-0 end-0">{{ event.event_time }}</span>
              <img src="{{ MEDIA_URL }}{{event.organized_by.photo}}" alt="matdash-img" class="img-fluid rounded-circle position-absolute bottom-0 start-0 mb-n9 ms-9" width="40" height="40" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Georgeanna Ramero">
            </div>
            <div class="card-body p-4">
              <span class="badge text-bg-light fs-2 py-1 px-2 lh-sm  mt-3">{{ event.organised_by }}</span>
              <a class="d-block my-4 fs-5 text-dark fw-semibold link-primary" href="">{{ event.event_name }}</a>
              <div class="d-flex align-items-center gap-4">
                <div class="d-flex align-items-center gap-2">
                  <i class="ti ti-eye text-dark fs-5"></i>{{ event.guests.count }} guests
                </div>
                <div class="d-flex align-items-center gap-2">
                  <i class="ti ti-message-2 text-dark fs-5"></i> {{event.location.seats_numbers}} seats
                </div>
                <div class="d-flex align-items-center fs-2 ms-auto">
                  <i class="ti ti-point text-dark"></i>{{ event.event_date }}
                </div>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}

      <div class="col-lg-12">
        <div class="card">
            <div class="card-body">
                <h1 class="card-title d-flex align-items-center gap-2">
                    Past events!
                  </h1>
            </div>
        </div>
    </div>

      {% for event in past_events %}
        <div class="col-lg-4">
          <div class="card overflow-hidden hover-img">
            <div class="position-relative">
              <a href="{% url 'personal_vizualizare_eveniment' event.id %}">
                <img src="{{ MEDIA_URL }}{{event.location.gallery}}" class="card-img-top" alt="matdash-img" style="filter: grayscale(50);">
              </a>
              <span class="badge text-bg-light text-dark fs-2 lh-sm mb-9 me-9 py-1 px-2 fw-semibold position-absolute bottom-0 end-0">{{ event.event_time }}</span>
              <img src="{{ MEDIA_URL }}{{event.organized_by.photo}}" alt="matdash-img" class="img-fluid rounded-circle position-absolute bottom-0 start-0 mb-n9 ms-9" width="40" height="40" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Georgeanna Ramero">
            </div>
            <div class="card-body p-4">
              <span class="badge text-bg-light fs-2 py-1 px-2 lh-sm  mt-3">{{ event.organised_by }}</span>
              <a class="d-block my-4 fs-5 text-dark fw-semibold link-primary" href="">{{ event.event_name }}</a>
              <div class="d-flex align-items-center gap-4">
                <div class="d-flex align-items-center gap-2">
                  <i class="ti ti-eye text-dark fs-5"></i>{{ event.guests.count }} guests
                </div>
                <div class="d-flex align-items-center gap-2">
                  <i class="ti ti-message-2 text-dark fs-5"></i> {{event.location.seats_numbers}} seats
                </div>
                <div class="d-flex align-items-center fs-2 ms-auto">
                  <i class="ti ti-point text-dark"></i>{{ event.event_date }}
                </div>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
  </div>
</div>
</div>
</div>
    <script src="https://cdn.jsdelivr.net/npm/konva@8.4.2/konva.min.js"></script>
    <script>
        // Dimensiuni canvas
        const width = 800;
        const height = 600;

        // Mock pentru structura sălii
        const sala = {
            mese: [
                { id: 1, numar: 1, x: 100, y: 150, tip: 'rotunda' },
                { id: 2, numar: 2, x: 300, y: 200, tip: 'dreptunghiulara' },
                { id: 3, numar: 3, x: 500, y: 400, tip: 'rotunda' },
            ],
            elemente: [
                { tip: 'scena', x: 50, y: 50, lungime: 200, latime: 50 },
            ],
        };

        // Crearea scenei Konva
        const stage = new Konva.Stage({
            container: 'container',
            width: width,
            height: height,
        });

        // Layer principal
        const layer = new Konva.Layer();

        // Desenează elementele sălii
        sala.elemente.forEach(element => {
            const rect = new Konva.Rect({
                x: element.x,
                y: element.y,
                width: element.lungime,
                height: element.latime,
                fill: element.tip === 'scena' ? 'green' : 'gray',
                stroke: 'black',
                strokeWidth: 1,
            });
            layer.add(rect);
        });

        // Desenează mesele
        sala.mese.forEach(masa => {
            const shape = masa.tip === 'rotunda'
                ? new Konva.Circle({
                      x: masa.x,
                      y: masa.y,
                      radius: 30,
                      fill: 'blue',
                      stroke: 'black',
                      strokeWidth: 2,
                      draggable: true,
                  })
                : new Konva.Rect({
                      x: masa.x - 30,
                      y: masa.y - 20,
                      width: 60,
                      height: 40,
                      fill: 'blue',
                      stroke: 'black',
                      strokeWidth: 2,
                      draggable: true,
                  });

            // Etichetează mesele
            const text = new Konva.Text({
                x: masa.x - 10,
                y: masa.y - 10,
                text: masa.numar.toString(),
                fontSize: 16,
                fill: 'white',
            });

            // Actualizează poziția textului la drag-and-drop
            shape.on('dragmove', function () {
                text.x(shape.x() - 10);
                text.y(shape.y() - 10);
            });

            layer.add(shape);
            layer.add(text);
        });

        // Adaugă layer-ul la scenă
        stage.add(layer);

        // Buton pentru salvare
        document.getElementById('save-btn').addEventListener('click', () => {
            const newPositions = sala.mese.map((masa, index) => {
                const shape = layer.children[index * 2]; // Obține forma mesei
                return {
                    id: masa.id,
                    x: shape.x(),
                    y: shape.y(),
                };
            });

            // Mock salvare (înlocuiește cu un request real API)
            console.log('Poziții noi salvate:', newPositions);
            alert('Pozițiile meselor au fost salvate!');
        });
    </script>  
{% endblock %}